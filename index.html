<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>WebGIS Viewer met Meten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- 1. Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha512-sA+e2fCJZL7jv8BeCtDstjTAj5v1kzQEu0uL5zUvr6+6H5NyzAT+5Yjb0Ur5/Usr5pEJ9mjOvXwVepALPh/6pg=="
    crossorigin=""
  />

  <!-- 2. Leaflet-Measure CSS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-measure/3.3.0/leaflet-measure.css"
    integrity="sha512-4XL8T8XHtO7y0bBQL6gDyu+p52clHSJ85b+i7V+453z0sZglCjLh26/K+qDOYjT8io7IiKHauKVnSWKAjrt6sg=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <style>
    :root {
      --btn-bg: #005f73;
      --btn-hover: #0a9396;
      --btn-active: #94d2bd;
      --btn-color: #fff;
      --btn-radius: 8px;
      --btn-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }

    /* Toolbar bovenin */
    .controls {
      position: absolute;
      top: 10px; left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex; gap: 8px;
    }
    #searchInput {
      width: 250px;
      padding: 6px 10px;
      border: 2px solid var(--btn-bg);
      border-radius: var(--btn-radius);
      font-size: 14px; outline: none;
    }
    #searchInput:focus { border-color: var(--btn-hover); }
    .custom-btn {
      background: var(--btn-bg);
      color: var(--btn-color);
      border: none; padding: 8px 12px;
      border-radius: var(--btn-radius);
      box-shadow: var(--btn-shadow);
      cursor: pointer;
      font-family: sans-serif; font-size: 14px;
      transition: background .2s, transform .1s;
      display: flex; align-items: center; justify-content: center;
    }
    .custom-btn:hover { background: var(--btn-hover); }
    .custom-btn:active { background: var(--btn-active); transform: scale(0.98); }

    /* Suggestielijst */
    #suggestions {
      position: absolute; top: 50px; left: 50%;
      transform: translateX(-50%);
      width: 250px; background: #fff;
      border: 1px solid #ccc; border-top: none;
      border-radius: 0 0 var(--btn-radius) var(--btn-radius);
      max-height: 150px; overflow-y: auto;
      z-index: 1001; list-style:none; margin:0; padding:0;
    }
    #suggestions li {
      padding: 6px 10px; cursor: pointer; font-size:14px;
    }
    #suggestions li:hover { background: #f0f0f0; }

    /* Zoom + Measure controls styling */
    .leaflet-control-zoom a,
    .leaflet-control-measure a {
      background: var(--btn-bg) !important;
      color: var(--btn-color) !important;
      width: 34px; height: 34px;
      line-height: 34px;
      text-align: center;
      border-radius: var(--btn-radius) !important;
      box-shadow: var(--btn-shadow) !important;
      margin: 4px 2px !important;
      font-size: 18px !important;
    }
    .leaflet-control-zoom a:hover,
    .leaflet-control-measure a:hover {
      background: var(--btn-hover) !important;
    }
    .leaflet-control-zoom a:active,
    .leaflet-control-measure a:active {
      background: var(--btn-active) !important;
      transform: scale(0.98) !important;
    }
  </style>
</head>
<body>

  <div class="controls">
    <input type="text" id="searchInput" placeholder="Zoek adres of plaats‚Ä¶" autocomplete="off">
    <button class="custom-btn" id="searchBtn">üîç</button>
    <button class="custom-btn" id="toggleBagBtn">üè† Panden</button>
  </div>
  <ul id="suggestions"></ul>
  <div id="map"></div>

  <!-- 3. Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha512-o9N1jz7+z+6+XzX2qgV5a+K0GonTk6WXpFfRlrPYRh7ghQSgSD6lXENX1xFD9LljY4o9IYOnG6Vx5vrmc3WmGQ=="
    crossorigin=""
  ></script>
  <!-- 4. Leaflet-Measure JS -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-measure/3.3.0/leaflet-measure.min.js"
    integrity="sha512-GI4rSM36EhMm5jwBrI+ivLRgAa1KcuqmI7wLISkDLTjQVncXOYfmJj0BRXYkptRcqiq3J5ssuRiSA7hG1fFSOQ=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  ></script>

  <script>
    // 1. Kaart initialiseren zonder standaard zoom controls
    const map = L.map('map', { zoomControl: false })
      .setView([52.155, 5.3875], 13);

    // 2. Ondergrond (OSM)
    const osmLayer = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution: '¬© OpenStreetMap contributors' }
    ).addTo(map);

    // 3. BAG-panden als WMS-laag
    const bagLayer = L.tileLayer.wms(
      'https://service.pdok.nl/lv/bag/wms/v2_0?',
      {
        layers: 'pand',
        format: 'image/png',
        transparent: true,
        version: '1.3.0',
        attribution: '¬© Kadaster / PDOK'
      }
    );
    document.getElementById('toggleBagBtn').onclick = () => {
      map.hasLayer(bagLayer) ? map.removeLayer(bagLayer) : map.addLayer(bagLayer);
    };

    // 4. Voeg √à√âN set gestylede zoom controls √©n de meet control toe op topright
    L.control.zoom({ position: 'topright' }).addTo(map);
    L.control.measure({
      position: 'topright',
      primaryLengthUnit: 'meters',
      secondaryLengthUnit: 'kilometers',
      primaryAreaUnit: 'sqmeters',
      secondaryAreaUnit: 'hectares'
    }).addTo(map);

    // 5. Zoek/autocomplete
    let zoekMarker, debounceTimer;
    const inputEl = document.getElementById('searchInput'),
          suggestionsEl = document.getElementById('suggestions');

    async function fetchSuggestions(q) {
      const url = [
        'https://api.pdok.nl/bzk/locatieserver/search/v3_1/free',
        `?q=${encodeURIComponent(q)}`,
        '&rows=5',
        '&fl=centroide_ll,weergavenaam'
      ].join('');
      const res = await fetch(url), js = await res.json();
      return js.response.docs || [];
    }

    function showSuggestions(docs) {
      suggestionsEl.innerHTML = '';
      docs.forEach(doc => {
        const li = document.createElement('li');
        li.textContent = doc.weergavenaam;
        li.dataset.centroide = doc.centroide_ll;
        suggestionsEl.appendChild(li);
      });
      suggestionsEl.style.display = docs.length ? 'block' : 'none';
    }

    inputEl.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      const q = inputEl.value.trim();
      if (q.length < 3) { suggestionsEl.innerHTML = ''; return; }
      debounceTimer = setTimeout(async () => {
        showSuggestions(await fetchSuggestions(q));
      }, 300);
    });

    suggestionsEl.addEventListener('click', e => {
      if (e.target.tagName!=='LI') return;
      const [lon, lat] = e.target.dataset.centroide
        .replace('POINT(','').replace(')','').split(' ').map(parseFloat);
      if (zoekMarker) map.removeLayer(zoekMarker);
      zoekMarker = L.marker([lat, lon]).addTo(map)
        .bindPopup(`<b>${e.target.textContent}</b>`).openPopup();
      map.setView([lat, lon], 14);
      inputEl.value = e.target.textContent;
      suggestionsEl.innerHTML = '';
    });

    document.getElementById('searchBtn').onclick = () =>
      inputEl.dispatchEvent(new Event('input'));

    // 6. Co√∂rdinaat-popup bij klikken
    map.on('click', e => {
      L.popup()
        .setLatLng(e.latlng)
        .setContent(
          `Co√∂rdinaten:<br>Lat: ${e.latlng.lat.toFixed(5)}, ` +
          `Lng: ${e.latlng.lng.toFixed(5)}`
        )
        .openOn(map);
    });
  </script>
</body>
</html>
