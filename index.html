<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGIS Viewer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 280px;
        }

        .search-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 320px;
        }

        .measure-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 240px;
        }

        .measure-panel h3 {
            font-size: 16px;
            margin-bottom: 12px;
        }

        .measure-panel .panel-section {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .measure-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .measure-buttons .btn {
            flex: 1;
            min-width: 75px;
            margin: 0 !important;
            padding: 8px 10px !important;
            font-size: 11px !important;
            white-space: nowrap;
        }

        .btn {
            background: linear-gradient(135deg, #76bc94, #5fa07e);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(118, 188, 148, 0.3);
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: linear-gradient(135deg, #5fa07e, #4d8568);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(118, 188, 148, 0.4);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(118, 188, 148, 0.3);
        }

        .btn.active {
            background: linear-gradient(135deg, #4d8568, #3a6b52);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .search-input:focus {
            outline: none;
            border-color: #76bc94;
            box-shadow: 0 0 0 3px rgba(118, 188, 148, 0.1);
        }

        .search-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .search-result {
            padding: 12px;
            background: #f8f9fa;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .search-result:hover {
            background: #e9f7f0;
            border-left-color: #76bc94;
            transform: translateX(5px);
        }

        .layer-control {
            margin: 10px 0;
        }

        .layer-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .layer-item:hover {
            background: #e9f7f0;
        }

        .layer-checkbox {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            accent-color: #76bc94;
        }

        .measure-result {
            background: #e9f7f0;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #76bc94;
            font-weight: 600;
        }

        .info-panel {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 320px;
            max-width: 450px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .kvk-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .kvk-company {
            background: #f8f9fa;
            border-left: 4px solid #76bc94;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
        }

        .kvk-company-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .kvk-company-details {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .kvk-loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .kvk-error {
            background: #fff5f5;
            border-left: 4px solid #e53e3e;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            color: #e53e3e;
            font-size: 12px;
        }

        .info-item {
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #76bc94;
        }

        .info-label {
            font-weight: 600;
            color: #333;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .info-value {
            color: #555;
            font-size: 14px;
        }

        h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 700;
        }

        .panel-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .panel-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .search-tab.active {
            border-bottom-color: #76bc94 !important;
            color: #76bc94 !important;
            font-weight: 600;
        }

        .search-mode {
            transition: all 0.3s ease;
        }

        .kvk-search-result {
            padding: 12px;
            background: #f8f9fa;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #76bc94;
        }

        .kvk-search-result:hover {
            background: #e9f7f0;
            transform: translateX(5px);
        }

        .kvk-result-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .kvk-result-details {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="search-container">
        <h3><i class="fas fa-search"></i> Zoeken</h3>
        <div class="search-tabs" style="display: flex; margin-bottom: 10px; border-bottom: 1px solid #e0e0e0;">
            <button id="searchTabAddress" class="search-tab active" style="flex: 1; padding: 8px; border: none; background: none; cursor: pointer; border-bottom: 2px solid #76bc94; color: #76bc94; font-weight: 600;">
                <i class="fas fa-map-marker-alt"></i> Adres
            </button>
            <button id="searchTabKvk" class="search-tab" style="flex: 1; padding: 8px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #666;">
                <i class="fas fa-building"></i> KVK
            </button>
        </div>
        
        <div id="addressSearch" class="search-mode">
            <input type="text" id="searchInput" class="search-input" placeholder="Zoek een adres..." />
            <button id="searchBtn" class="btn btn-small">
                <i class="fas fa-search"></i> Zoeken
            </button>
        </div>
        
        <div id="kvkSearch" class="search-mode" style="display: none;">
            <input type="text" id="kvkSearchInput" class="search-input" placeholder="KVK nummer (bijv. 90000749)" />
            <button id="kvkSearchBtn" class="btn btn-small">
                <i class="fas fa-building"></i> Zoek bedrijf
            </button>
        </div>
        
        <div id="searchResults" class="search-results"></div>
    </div>

    <div class="control-panel">
        <div class="panel-section">
            <h3><i class="fas fa-layer-group"></i> Kaartlagen</h3>
            <div class="layer-control">
                <div class="layer-item">
                    <input type="checkbox" id="osmLayer" class="layer-checkbox" checked>
                    <label for="osmLayer">OpenStreetMap</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="bagLayer" class="layer-checkbox">
                    <label for="bagLayer">BAG Panden</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="topoLayer" class="layer-checkbox">
                    <label for="topoLayer">Topografische kaart</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="luchtfotoLayer" class="layer-checkbox">
                    <label for="luchtfotoLayer">Luchtfoto</label>
                </div>
            </div>
        </div>
    </div>

    <div class="measure-panel">
        <h3><i class="fas fa-ruler"></i> Meettools</h3>
        <div class="measure-buttons">
            <button id="measureDistance" class="btn">
                <i class="fas fa-ruler-horizontal"></i> Afstand
            </button>
            <button id="measureArea" class="btn">
                <i class="fas fa-draw-polygon"></i> Gebied
            </button>
            <button id="clearMeasurements" class="btn">
                <i class="fas fa-trash"></i> Wis
            </button>
        </div>
        <div id="measureResults"></div>
    </div>

    <div class="info-panel" id="infoPanel" style="display: none;">
        <h3><i class="fas fa-info-circle"></i> Locatie informatie</h3>
        <div id="infoContent">
            <p>Klik op een pand om informatie te bekijken</p>
        </div>
        <div id="kvkSection" class="kvk-section" style="display: none;">
            <h4><i class="fas fa-building"></i> Bedrijven (KVK)</h4>
            <div id="kvkContent"></div>
        </div>
        <button id="closeInfo" class="btn btn-small">
            <i class="fas fa-times"></i> Sluiten
        </button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        // Debug functie
        function log(message) {
            console.log('WebGIS Debug:', message);
        }

        log('Starting map initialization...');

        // Controleer of Leaflet geladen is
        if (typeof L === 'undefined') {
            alert('Leaflet library niet geladen!');
        } else {
            log('Leaflet loaded successfully');
        }

        // Initialiseer de kaart gecentreerd op Nederland
        let map;
        try {
            map = L.map('map').setView([52.3676, 4.9041], 8);
            log('Map container initialized');
        } catch (error) {
            log('Error initializing map: ' + error.message);
            alert('Fout bij initialiseren kaart: ' + error.message);
        }

        // Originele Nederlandse kaartlagen met verbeterde configuratie
        let osmLayer;
        
        try {
            // OpenStreetMap met betere configuratie
            osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19,
                subdomains: ['a', 'b', 'c'],
                tileSize: 256,
                zoomOffset: 0,
                detectRetina: false
            });
            
            osmLayer.on('loading', function() {
                log('OSM tiles are loading...');
            });
            
            osmLayer.on('load', function() {
                log('OSM tiles loaded successfully');
            });
            
            osmLayer.on('tileerror', function(e) {
                log('OSM tile error: ' + e.error);
                console.log('Failed tile URL:', e.tile.src);
            });
            
            osmLayer.addTo(map);
            log('OSM layer added to map');
        } catch (error) {
            log('Error loading OSM layer: ' + error.message);
        }

        // PDOK Topografische kaart - BRT Achtergrondkaart
        const topoLayer = L.tileLayer('https://service.pdok.nl/brt/achtergrondkaart/wmts/v2_0/standaard/EPSG:3857/{z}/{x}/{y}.png', {
            attribution: '© PDOK, Kadaster',
            maxZoom: 19,
            tileSize: 256,
            zoomOffset: 0
        });

        // PDOK Luchtfoto - Actueel ortho HR
        const luchtfotoLayer = L.tileLayer('https://service.pdok.nl/hwh/luchtfotorgb/wmts/v1_0/Actueel_orthoHR/EPSG:3857/{z}/{x}/{y}.jpeg', {
            attribution: '© PDOK, Beeldmateriaal.nl',
            maxZoom: 19,
            tileSize: 256,
            zoomOffset: 0
        });

        // BAG WMS laag voor panden
        const bagLayer = L.tileLayer.wms('https://service.pdok.nl/lv/bag/wms/v2_0', {
            layers: 'pand',
            format: 'image/png',
            transparent: true,
            attribution: '© PDOK, BAG',
            uppercase: true,
            version: '1.3.0',
            crs: L.CRS.EPSG3857
        });

        // Kaartlagen object
        const layers = {
            osm: osmLayer,
            topo: topoLayer,
            luchtfoto: luchtfotoLayer,
            bag: bagLayer
        };

        // Search timeout variabele
        let searchTimeout;

        // Event listeners voor laag checkboxes
        document.getElementById('osmLayer').addEventListener('change', function() {
            if (this.checked) {
                if (!osmLayer) {
                    osmLayer = createOsmLayer(currentOsmIndex);
                }
                if (osmLayer && !map.hasLayer(osmLayer)) {
                    map.addLayer(osmLayer);
                }
            } else {
                if (osmLayer && map.hasLayer(osmLayer)) {
                    map.removeLayer(osmLayer);
                }
            }
        });').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.osm);
            } else {
                map.removeLayer(layers.osm);
            }
        });

        document.getElementById('topoLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.topo);
            } else {
                map.removeLayer(layers.topo);
            }
        });

        document.getElementById('bagLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.bag);
            } else {
                map.removeLayer(layers.bag);
            }
        });

        document.getElementById('luchtfotoLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.luchtfoto);
            } else {
                map.removeLayer(layers.luchtfoto);
            }
        });

        // Zoekfunctionaliteit
        let searchMarker;

        function searchAddress() {
            const query = document.getElementById('searchInput').value.trim();
            console.log('Search function called with query:', query);
            
            if (!query || query.length < 2) {
                console.log('Query too short, clearing results');
                document.getElementById('searchResults').innerHTML = '';
                return;
            }

            const url = `https://api.pdok.nl/bzk/locatieserver/search/v3_1/suggest?q=${encodeURIComponent(query)}&fq=type:adres&rows=10`;
            console.log('Search URL:', url);

            fetch(url)
                .then(response => {
                    console.log('Search response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Search data received:', data);
                    if (data.response && data.response.docs) {
                        console.log('Found', data.response.docs.length, 'results');
                        displaySearchResults(data.response.docs);
                    } else {
                        console.log('No docs in response');
                        displaySearchResults([]);
                    }
                })
                .catch(error => {
                    console.error('Zoekfout:', error);
                    const container = document.getElementById('searchResults');
                    container.innerHTML = `<div class="search-result" style="color: #e74c3c;">Fout bij zoeken: ${error.message}</div>`;
                });
        }

        function displaySearchResults(results) {
            console.log('Displaying search results:', results);
            const container = document.getElementById('searchResults');
            
            if (!container) {
                console.error('Search results container not found!');
                return;
            }
            
            container.innerHTML = '';

            if (!results || results.length === 0) {
                container.innerHTML = '<div class="search-result">Geen resultaten gevonden</div>';
                return;
            }

            results.slice(0, 8).forEach((result, index) => {
                console.log(`Creating result ${index}:`, result);
                
                const div = document.createElement('div');
                div.className = 'search-result';
                
                const mainText = document.createElement('div');
                mainText.style.fontWeight = '600';
                mainText.style.color = '#333';
                mainText.textContent = result.weergavenaam || result.display_name || 'Onbekend adres';
                
                const subText = document.createElement('div');
                subText.style.fontSize = '12px';
                subText.style.color = '#666';
                subText.style.marginTop = '4px';
                
                const details = [];
                if (result.gemeentenaam) details.push(result.gemeentenaam);
                if (result.provincienaam) details.push(result.provincienaam);
                if (result.type) details.push(`(${result.type})`);
                subText.textContent = details.join(', ');
                
                div.appendChild(mainText);
                if (subText.textContent) div.appendChild(subText);
                
                div.addEventListener('click', () => {
                    console.log('Search result clicked:', result);
                    selectSearchResult(result.id);
                });
                
                container.appendChild(div);
            });
            
            console.log('Search results displayed in container');
        }

        function selectSearchResult(id) {
            const url = `https://api.pdok.nl/bzk/locatieserver/search/v3_1/lookup?id=${id}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.response.docs.length > 0) {
                        const doc = data.response.docs[0];
                        console.log('Search result doc:', doc);
                        
                        let lat, lng;
                        
                        if (doc.centroide_ll) {
                            console.log('Raw centroide_ll:', doc.centroide_ll);
                            
                            if (doc.centroide_ll.startsWith('POINT(')) {
                                const coordString = doc.centroide_ll.replace('POINT(', '').replace(')', '');
                                const coords = coordString.split(' ');
                                lng = parseFloat(coords[0]);
                                lat = parseFloat(coords[1]);
                            } else {
                                const coords = doc.centroide_ll.split(' ');
                                lng = parseFloat(coords[0]);
                                lat = parseFloat(coords[1]);
                            }
                        }

                        console.log('Parsed coordinates:', { lat, lng });

                        if (isNaN(lat) || isNaN(lng)) {
                            console.error('Ongeldige coördinaten na parsing. Raw data:', doc.centroide_ll);
                            return;
                        }

                        if (searchMarker) {
                            map.removeLayer(searchMarker);
                        }

                        searchMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'custom-search-marker',
                                html: `<div style="
                                    background-color: #76bc94;
                                    border: 3px solid white;
                                    border-radius: 50%;
                                    width: 20px;
                                    height: 20px;
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                                    position: relative;
                                "></div>
                                <div style="
                                    position: absolute;
                                    top: 20px;
                                    left: 50%;
                                    transform: translateX(-50%);
                                    width: 0;
                                    height: 0;
                                    border-left: 6px solid transparent;
                                    border-right: 6px solid transparent;
                                    border-top: 8px solid #76bc94;
                                    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
                                "></div>`,
                                iconSize: [20, 28],
                                iconAnchor: [10, 28],
                                popupAnchor: [0, -28]
                            })
                        }).addTo(map);

                        const popupContent = `
                            <div style="font-family: 'Segoe UI', sans-serif;">
                                <strong style="color: #76bc94;">${doc.weergavenaam}</strong><br>
                                ${doc.gemeentenaam ? `<small>${doc.gemeentenaam}</small>` : ''}
                            </div>
                        `;
                        
                        searchMarker.bindPopup(popupContent).openPopup();

                        console.log('Flying to coordinates:', lat, lng);
                        map.flyTo([lat, lng], 18, {
                            animate: true,
                            duration: 1.5
                        });
                        
                        document.getElementById('searchResults').innerHTML = '';
                        document.getElementById('searchInput').value = doc.weergavenaam;
                        
                        console.log('Zoom completed to:', lat, lng);
                    }
                })
                .catch(error => {
                    console.error('Locatie ophalen fout:', error);
                });
        }

        // Zoektabs functionaliteit
        document.getElementById('searchTabAddress').addEventListener('click', function() {
            document.getElementById('searchTabAddress').classList.add('active');
            document.getElementById('searchTabKvk').classList.remove('active');
            document.getElementById('addressSearch').style.display = 'block';
            document.getElementById('kvkSearch').style.display = 'none';
            document.getElementById('searchResults').innerHTML = '';
        });

        document.getElementById('searchTabKvk').addEventListener('click', function() {
            document.getElementById('searchTabKvk').classList.add('active');
            document.getElementById('searchTabAddress').classList.remove('active');
            document.getElementById('kvkSearch').style.display = 'block';
            document.getElementById('addressSearch').style.display = 'none';
            document.getElementById('searchResults').innerHTML = '';
        });

        // KVK API configuratie
        const KVK_CONFIG = {
            testMode: true
        };

        // Mock KVK data functie
        function getMockKvkData(kvkNumber) {
            const mockCompanies = {
                '90000749': {
                    kvkNummer: '90000749',
                    naam: 'Global Conron B.V.',
                    type: 'rechtspersoon',
                    adres: {
                        straatnaam: 'Blaauwweg',
                        huisnummer: '1',
                        postcode: '3311 AA',
                        plaats: 'Dordrecht',
                        type: 'bezoekadres'
                    },
                    rechtsvorm: 'Besloten Vennootschap',
                    hoofdactiviteit: 'Zakelijke dienstverlening',
                    status: 'Actief'
                },
                '12345678': {
                    kvkNummer: '12345678',
                    naam: 'Test Bedrijf Nederland B.V.',
                    type: 'rechtspersoon',
                    adres: {
                        straatnaam: 'Teststraat',
                        huisnummer: '123',
                        postcode: '1234 AB',
                        plaats: 'Amsterdam',
                        type: 'bezoekadres'
                    },
                    rechtsvorm: 'Besloten Vennootschap',
                    hoofdactiviteit: 'Softwareontwikkeling',
                    status: 'Actief'
                }
            };

            return mockCompanies[kvkNumber] ? [mockCompanies[kvkNumber]] : [];
        }

        // Test KVK API functie
        async function testKvkApi() {
            console.log('🧪 Testing KVK API...');
            
            // Simuleer API test met promise
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log('✅ Using mock KVK data');
                    resolve({
                        resultaten: getMockKvkData('90000749'),
                        success: true
                    });
                }, 500);
            });
        }

        // Toon API beperkingen
        function showApiLimitations() {
            const container = document.getElementById('searchResults');
            container.innerHTML = `
                <div style="padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; margin: 10px 0;">
                    <h4 style="color: #856404; margin-bottom: 10px;">
                        <i class="fas fa-exclamation-triangle"></i> KVK API Beperking
                    </h4>
                    <p style="color: #856404; font-size: 13px; line-height: 1.4; margin-bottom: 10px;">
                        De KVK API kan niet direct vanuit de browser worden aangeroepen vanwege CORS-beleidsregels.
                        Dit is een beveiligingsmaatregel van de KVK API.
                    </p>
                    <p style="color: #856404; font-size: 13px
