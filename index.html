<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assetmaps met OpenKVK</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 280px;
        }

        .search-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 320px;
        }

        .measure-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 240px;
        }

        .btn {
            background: linear-gradient(135deg, #76bc94, #5fa07e);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(118, 188, 148, 0.3);
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: linear-gradient(135deg, #5fa07e, #4d8568);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(118, 188, 148, 0.4);
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
        }

        .btn-streetview {
            background: linear-gradient(135deg, #4285f4, #3367d6);
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        }

        .btn-streetview:hover {
            background: linear-gradient(135deg, #3367d6, #2b57c8);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .search-input:focus {
            outline: none;
            border-color: #76bc94;
            box-shadow: 0 0 0 3px rgba(118, 188, 148, 0.1);
        }

        .search-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .search-result {
            padding: 12px;
            background: #f8f9fa;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .search-result:hover {
            background: #e9f7f0;
            border-left-color: #76bc94;
            transform: translateX(5px);
        }

        .layer-control {
            margin: 10px 0;
        }

        .layer-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .layer-item:hover {
            background: #e9f7f0;
        }

        .layer-checkbox {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            accent-color: #76bc94;
        }

        .info-panel {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 320px;
            max-width: 450px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .info-item {
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #76bc94;
        }

        .info-label {
            font-weight: 600;
            color: #333;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .info-value {
            color: #555;
            font-size: 14px;
        }

        h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 700;
        }

        .search-tab.active {
            border-bottom-color: #76bc94 !important;
            color: #76bc94 !important;
            font-weight: 600;
        }

        /* Street View Overlay Styles */
        .streetview-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            backdrop-filter: blur(5px);
        }

        .streetview-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90vw;
            height: 80vh;
            max-width: 1200px;
            max-height: 800px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .streetview-header {
            background: linear-gradient(135deg, #4285f4, #3367d6);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 16px 16px 0 0;
        }

        .streetview-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .streetview-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 6px;
            transition: background 0.3s ease;
        }

        .streetview-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .streetview-content {
            flex: 1;
            position: relative;
            background: #f0f0f0;
        }

        .streetview-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .streetview-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
            font-size: 16px;
        }

        .streetview-error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #e74c3c;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-width: 400px;
        }

        .streetview-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .streetview-info {
            flex: 1;
            min-width: 200px;
            font-size: 14px;
            color: #333;
        }

        .streetview-coords {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .info-bar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            background: rgba(118, 188, 148, 0.95);
            color: white;
            border-radius: 12px;
            padding: 12px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            max-width: 500px;
            min-width: 350px;
        }

        /* Mobile adaptations */
        @media (max-width: 768px) {
            .control-panel,
            .search-container,
            .measure-panel {
                display: none !important;
            }

            .info-panel {
                position: fixed;
                bottom: 10px;
                left: 10px;
                right: 10px;
                max-width: none;
                min-width: auto;
                width: calc(100vw - 20px);
                max-height: 60vh;
                z-index: 1001;
            }
            
            .info-bar {
                top: 10px !important;
                left: 10px !important;
                right: 10px !important;
                transform: none !important;
                max-width: none !important;
                min-width: auto !important;
                width: calc(100vw - 20px) !important;
                font-size: 13px !important;
                padding: 10px 15px !important;
            }

            .streetview-modal {
                width: 95vw;
                height: 90vh;
                border-radius: 12px;
            }

            .streetview-header {
                padding: 12px 15px;
                border-radius: 12px 12px 0 0;
            }

            .streetview-title {
                font-size: 16px;
            }

            .streetview-controls {
                bottom: 10px;
                left: 10px;
                right: 10px;
                padding: 12px;
                flex-direction: column;
                gap: 8px;
            }

            .streetview-info {
                text-align: center;
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Info Bar -->
    <div class="info-bar" id="infoBar">
        <i class="fas fa-info-circle"></i>
        <span id="infoBarText">Zoom in en klik op een gebouw voor pand- en bedrijfsinformatie</span>
    </div>

    <div class="search-container">
        <h3><i class="fas fa-search"></i> Zoeken</h3>
        <div class="search-tabs" style="display: flex; margin-bottom: 10px; border-bottom: 1px solid #e0e0e0;">
            <button id="searchTabAddress" class="search-tab active" style="flex: 1; padding: 8px; border: none; background: none; cursor: pointer; border-bottom: 2px solid #76bc94; color: #76bc94; font-weight: 600;">
                <i class="fas fa-map-marker-alt"></i> Adres
            </button>
            <button id="searchTabKvk" class="search-tab" style="flex: 1; padding: 8px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #666;">
                <i class="fas fa-building"></i> KVK
            </button>
        </div>
        
        <div id="addressSearch" class="search-mode">
            <input type="text" id="searchInput" class="search-input" placeholder="Zoek een adres..." />
            <button id="searchBtn" class="btn btn-small">
                <i class="fas fa-search"></i> Zoeken
            </button>
        </div>
        
        <div id="kvkSearch" class="search-mode" style="display: none;">
            <input type="text" id="kvkSearchInput" class="search-input" placeholder="KVK nummer of bedrijfsnaam" />
            <button id="kvkSearchBtn" class="btn btn-small">
                <i class="fas fa-building"></i> Zoek bedrijf
            </button>
        </div>
        
        <div id="searchResults" class="search-results"></div>
    </div>

    <div class="control-panel">
        <div class="panel-section">
            <h3><i class="fas fa-layer-group"></i> Kaartlagen</h3>
            <div class="layer-control">
                <div class="layer-item">
                    <input type="checkbox" id="bagLayer" class="layer-checkbox" checked>
                    <label for="bagLayer">BAG Panden (voor gebouwinformatie)</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="osmLayer" class="layer-checkbox" checked>
                    <label for="osmLayer">OpenStreetMap</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="topoLayer" class="layer-checkbox">
                    <label for="topoLayer">Topografische kaart</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="luchtfotoLayer" class="layer-checkbox">
                    <label for="luchtfotoLayer">Luchtfoto</label>
                </div>
            </div>
        </div>
    </div>

    <div class="measure-panel">
        <h3><i class="fas fa-ruler"></i> Meettools</h3>
        <div class="measure-buttons">
            <button id="measureDistance" class="btn btn-small">
                <i class="fas fa-ruler-horizontal"></i> Afstand
            </button>
            <button id="measureArea" class="btn btn-small">
                <i class="fas fa-draw-polygon"></i> Gebied
            </button>
            <button id="clearMeasurements" class="btn btn-small">
                <i class="fas fa-trash"></i> Wis
            </button>
        </div>
        <div id="measureResults"></div>
    </div>

    <div class="info-panel" id="infoPanel" style="display: none;">
        <h3><i class="fas fa-info-circle"></i> Locatie informatie</h3>
        <div id="infoContent">
            <p>Klik op een pand om informatie te bekijken</p>
        </div>
        <div id="kvkSection" class="kvk-section" style="display: none;">
            <h4><i class="fas fa-building"></i> Bedrijven (OpenKVK)</h4>
            <div id="kvkContent"></div>
        </div>
        <div style="margin-top: 15px; text-align: center;">
            <button id="streetViewBtn" class="btn btn-streetview btn-small" style="margin-right: 10px;">
                <i class="fas fa-street-view"></i> Street View
            </button>
            <button id="closeInfo" class="btn btn-small">
                <i class="fas fa-times"></i> Sluiten
            </button>
        </div>
    </div>

    <!-- Street View Overlay -->
    <div class="streetview-overlay" id="streetViewOverlay">
        <div class="streetview-modal">
            <div class="streetview-header">
                <div class="streetview-title">
                    <i class="fas fa-street-view"></i>
                    <span>Google Street View</span>
                </div>
                <button class="streetview-close" id="streetViewClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="streetview-content">
                <div class="streetview-container" id="streetViewContainer">
                    <div class="streetview-loading" id="streetViewLoading">
                        <i class="fas fa-spinner fa-spin"></i><br>
                        Street View laden...
                    </div>
                </div>
                <div class="streetview-controls" id="streetViewControls" style="display: none;">
                    <div class="streetview-info">
                        <div id="streetViewAddress">Locatie wordt geladen...</div>
                        <div class="streetview-coords" id="streetViewCoords"></div>
                    </div>
                    <button id="streetViewFullscreen" class="btn btn-small btn-streetview">
                        <i class="fas fa-expand"></i> Volledig scherm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <!-- Replace YOUR_GOOGLE_MAPS_API_KEY with your actual API key -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initStreetView"></script>
    <script>
        // ========================================
        // GLOBAL VARIABLES & CONFIGURATION
        // ========================================
        
        let streetViewService;
        let streetViewPanorama;
        let currentStreetViewLocation = null;
        let map;
        let searchMarker;
        let currentLocationData = null;

        // OpenKVK API Configuration
        const OPENKVK_CONFIG = {
            baseUrl: 'https://api.overheid.io/v3/openkvk',
            suggestUrl: 'https://api.overheid.io/v3/suggest/openkvk',
            apiKey: 'af0f54b3b1a1718d8003866dd8fcae6d7d3eff2e726c72b99bbc60756870d455',
            maxSearchResults: 5,
            minSearchLength: 3
        };

        function log(message) {
            console.log('WebGIS Debug:', message);
        }

        function showStatus(message, type = 'info') {
            updateInfoBar(message, type === 'success' ? 'fas fa-check-circle' : type === 'error' ? 'fas fa-exclamation-triangle' : 'fas fa-info-circle');
        }

        function updateInfoBar(message, icon = 'fas fa-info-circle') {
            const infoBar = document.getElementById('infoBar');
            const infoText = document.getElementById('infoBarText');
            
            if (infoBar && infoText) {
                const iconElement = infoBar.querySelector('i');
                if (iconElement) {
                    iconElement.className = icon;
                }
                infoText.textContent = message;
            }
        }

        // ========================================
        // GOOGLE STREET VIEW INTEGRATION
        // ========================================

        function initStreetView() {
            console.log('üó∫Ô∏è Initializing Google Street View service...');
            
            try {
                if (typeof google !== 'undefined' && google.maps) {
                    streetViewService = new google.maps.StreetViewService();
                    console.log('‚úÖ Google Street View service initialized');
                    showStatus('Google Street View geladen', 'success');
                } else {
                    console.error('‚ùå Google Maps API not loaded');
                    showStatus('Google Street View niet beschikbaar', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error initializing Street View:', error);
                showStatus('Google Street View niet beschikbaar', 'error');
            }
        }

        function openStreetView(lat, lng, address = null) {
            console.log('üó∫Ô∏è Opening Street View for:', lat, lng);
            
            if (!streetViewService) {
                showStatus('Google Street View niet beschikbaar', 'error');
                return;
            }

            currentStreetViewLocation = { lat, lng, address };
            
            const overlay = document.getElementById('streetViewOverlay');
            const loading = document.getElementById('streetViewLoading');
            const controls = document.getElementById('streetViewControls');
            const container = document.getElementById('streetViewContainer');
            
            // Show overlay and loading
            overlay.style.display = 'block';
            loading.style.display = 'block';
            controls.style.display = 'none';
            
            // Clear previous Street View if any
            if (streetViewPanorama) {
                streetViewPanorama = null;
            }
            
            // Update address info
            const addressElement = document.getElementById('streetViewAddress');
            const coordsElement = document.getElementById('streetViewCoords');
            
            addressElement.textContent = address || 'Onbekende locatie';
            coordsElement.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            
            // Check if Street View is available at this location
            const position = new google.maps.LatLng(lat, lng);
            
            streetViewService.getPanorama({
                location: position,
                radius: 50,
                source: google.maps.StreetViewSource.OUTDOOR
            }, (data, status) => {
                console.log('Street View status:', status);
                
                if (status === google.maps.StreetViewStatus.OK) {
                    console.log('‚úÖ Street View available, loading panorama...');
                    loadStreetViewPanorama(data.location.latLng, address);
                } else {
                    console.log('‚ùå No Street View available at this location');
                    showStreetViewError('Geen Street View beschikbaar op deze locatie');
                }
            });
        }

        function loadStreetViewPanorama(position, address) {
            const container = document.getElementById('streetViewContainer');
            const loading = document.getElementById('streetViewLoading');
            const controls = document.getElementById('streetViewControls');
            
            try {
                // Create Street View panorama
                streetViewPanorama = new google.maps.StreetViewPanorama(container, {
                    position: position,
                    pov: {
                        heading: 0,
                        pitch: 0
                    },
                    zoom: 1,
                    addressControl: false,
                    linksControl: true,
                    panControl: true,
                    zoomControl: true,
                    fullscreenControl: false,
                    motionTracking: false,
                    motionTrackingControl: false
                });

                // Hide loading and show controls when panorama is ready
                google.maps.event.addListener(streetViewPanorama, 'pano_changed', () => {
                    console.log('‚úÖ Street View panorama loaded');
                    loading.style.display = 'none';
                    controls.style.display = 'flex';
                    showStatus('Street View geladen', 'success');
                });

                // Handle panorama errors
                google.maps.event.addListener(streetViewPanorama, 'error', (error) => {
                    console.error('Street View panorama error:', error);
                    showStreetViewError('Fout bij laden Street View');
                });

            } catch (error) {
                console.error('Error creating Street View panorama:', error);
                showStreetViewError('Fout bij laden Street View: ' + error.message);
            }
        }

        function showStreetViewError(message) {
            const container = document.getElementById('streetViewContainer');
            const loading = document.getElementById('streetViewLoading');
            const controls = document.getElementById('streetViewControls');
            
            loading.style.display = 'none';
            controls.style.display = 'none';
            
            container.innerHTML = `
                <div class="streetview-error">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #e74c3c; margin-bottom: 15px;"></i>
                    <h3 style="margin-bottom: 10px; color: #e74c3c;">Street View niet beschikbaar</h3>
                    <p style="margin-bottom: 15px;">${message}</p>
                    <button onclick="closeStreetView()" class="btn btn-small">
                        <i class="fas fa-times"></i> Sluiten
                    </button>
                </div>
            `;
            
            showStatus(message, 'error');
        }

        function closeStreetView() {
            console.log('üó∫Ô∏è Closing Street View');
            
            const overlay = document.getElementById('streetViewOverlay');
            overlay.style.display = 'none';
            
            // Clean up panorama
            if (streetViewPanorama) {
                streetViewPanorama = null;
            }
            
            // Reset container
            const container = document.getElementById('streetViewContainer');
            container.innerHTML = `
                <div class="streetview-loading" id="streetViewLoading">
                    <i class="fas fa-spinner fa-spin"></i><br>
                    Street View laden...
                </div>
            `;
            
            currentStreetViewLocation = null;
        }

        function openStreetViewFullscreen() {
            if (!currentStreetViewLocation) return;
            
            const { lat, lng } = currentStreetViewLocation;
            const url = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`;
            window.open(url, '_blank');
        }

        // ========================================
        // MAP INITIALIZATION
        // ========================================

        // Initialize map
        try {
            map = L.map('map').setView([52.3676, 4.9041], 8);
            log('Map container initialized');
        } catch (error) {
            log('Error initializing map: ' + error.message);
            alert('Fout bij initialiseren kaart: ' + error.message);
        }

        // Map layers
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        const topoLayer = L.tileLayer('https://service.pdok.nl/brt/achtergrondkaart/wmts/v2_0/standaard/EPSG:3857/{z}/{x}/{y}.png', {
            attribution: '¬© PDOK',
            maxZoom: 19
        });

        const luchtfotoLayer = L.tileLayer('https://service.pdok.nl/hwh/luchtfotorgb/wmts/v1_0/Actueel_orthoHR/EPSG:3857/{z}/{x}/{y}.jpeg', {
            attribution: '¬© PDOK Luchtfoto',
            maxZoom: 19
        });

        const bagLayer = L.tileLayer.wms('https://service.pdok.nl/lv/bag/wms/v2_0', {
            layers: 'pand',
            format: 'image/png',
            transparent: true,
            opacity: 0.7,
            attribution: '¬© BAG',
            zIndex: 1000
        });

        const layers = {
            osm: osmLayer,
            topo: topoLayer,
            luchtfoto: luchtfotoLayer,
            bag: bagLayer
        };

        // ========================================
        // SEARCH FUNCTIONALITY
        // ========================================

        let searchTimeout;

        function searchAddress() {
            const query = document.getElementById('searchInput').value.trim();
            console.log('Search function called with query:', query);
            
            if (!query || query.length < 2) {
                document.getElementById('searchResults').innerHTML = '';
                return;
            }

            const url = `https://api.pdok.nl/bzk/locatieserver/search/v3_1/suggest?q=${encodeURIComponent(query)}&fq=type:adres&rows=10`;

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.response && data.response.docs) {
                        displaySearchResults(data.response.docs);
                    } else {
                        displaySearchResults([]);
                    }
                })
                .catch(error => {
                    console.error('Zoekfout:', error);
                    const container = document.getElementById('searchResults');
                    container.innerHTML = `<div class="search-result" style="color: #e74c3c;">Fout bij zoeken: ${error.message}</div>`;
                });
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';

            if (!results || results.length === 0) {
                container.innerHTML = '<div class="search-result">Geen resultaten gevonden</div>';
                return;
            }

            results.slice(0, 8).forEach((result) => {
                const div = document.createElement('div');
                div.className = 'search-result';
                
                const mainText = document.createElement('div');
                mainText.style.fontWeight = '600';
                mainText.style.color = '#333';
                mainText.textContent = result.weergavenaam || result.display_name || 'Onbekend adres';
                
                const subText = document.createElement('div');
                subText.style.fontSize = '12px';
                subText.style.color = '#666';
                subText.style.marginTop = '4px';
                
                const details = [];
                if (result.gemeentenaam) details.push(result.gemeentenaam);
                if (result.provincienaam) details.push(result.provincienaam);
                if (result.type) details.push(`(${result.type})`);
                subText.textContent = details.join(', ');
                
                div.appendChild(mainText);
                if (subText.textContent) div.appendChild(subText);
                
                div.addEventListener('click', () => {
                    selectSearchResult(result.id);
                });
                
                container.appendChild(div);
            });
        }

        function selectSearchResult(id) {
            const url = `https://api.pdok.nl/bzk/locatieserver/search/v3_1/lookup?id=${id}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.response.docs.length > 0) {
                        const doc = data.response.docs[0];
                        let lat, lng;
                        
                        if (doc.centroide_ll) {
                            if (doc.centroide_ll.startsWith('POINT(')) {
                                const coordString = doc.centroide_ll.replace('POINT(', '').replace(')', '');
                                const coords = coordString.split(' ');
                                lng = parseFloat(coords[0]);
                                lat = parseFloat(coords[1]);
                            } else {
                                const coords = doc.centroide_ll.split(' ');
                                lng = parseFloat(coords[0]);
                                lat = parseFloat(coords[1]);
                            }
                        }

                        if (isNaN(lat) || isNaN(lng)) {
                            console.error('Ongeldige co√∂rdinaten');
                            return;
                        }

                        if (searchMarker) {
                            map.removeLayer(searchMarker);
                        }

                        searchMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'custom-search-marker',
                                html: `<div style="
                                    background-color: #76bc94;
                                    border: 3px solid white;
                                    border-radius: 50%;
                                    width: 20px;
                                    height: 20px;
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                                "></div>`,
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).addTo(map);

                        const popupContent = `
                            <div style="font-family: 'Segoe UI', sans-serif;">
                                <strong style="color: #76bc94;">${doc.weergavenaam}</strong><br>
                                ${doc.gemeentenaam ? `<small>${doc.gemeentenaam}</small>` : ''}
                            </div>
                        `;
                        
                        searchMarker.bindPopup(popupContent).openPopup();

                        map.flyTo([lat, lng], 18, {
                            animate: true,
                            duration: 1.5
                        });
                        
                        // Store location for Street View
                        currentLocationData = {
                            lat: lat,
                            lng: lng,
                            address: doc.weergavenaam
                        };
                        
                        document.getElementById('searchResults').innerHTML = '';
                        document.getElementById('searchInput').value = doc.weergavenaam;
                    }
                })
                .catch(error => {
                    console.error('Locatie ophalen fout:', error);
                });
        }

        // ========================================
        // KVK FUNCTIONALITY (SIMPLIFIED)
        // ========================================

        async function searchKvkViaSuggest(query) {
            if (!query || query.length < OPENKVK_CONFIG.minSearchLength) {
                return [];
            }
            
            try {
                const url = `${OPENKVK_CONFIG.suggestUrl}/${encodeURIComponent(query)}?ovio-api-key=${OPENKVK_CONFIG.apiKey}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 
                        'Accept': 'application/json',
                        'ovio-api-key': OPENKVK_CONFIG.apiKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (Array.isArray(data) && data.length > 0) {
                    const limitedResults = data.slice(0, OPENKVK_CONFIG.maxSearchResults);
                    return limitedResults.map(item => ({
                        kvkNummer: item.kvknummer,
                        naam: item.naam,
                        postcode: item.postcode,
                        vestigingsnummer: item.vestigingsnummer,
                        link: item.link
                    }));
                }
                
                return [];
                
            } catch (error) {
                console.error('KVK search error:', error);
                return [];
            }
        }

        function displayKvkSearchResults(suggestions) {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';
            
            if (!suggestions || suggestions.length === 0) {
                container.innerHTML = '<div class="search-result">Geen bedrijven gevonden</div>';
                return;
            }
            
            suggestions.forEach((suggestion) => {
                const div = document.createElement('div');
                div.className = 'search-result';
                div.style.borderLeft = '4px solid #76bc94';
                
                div.innerHTML = `
                    <div style="font-weight: 600; color: #333; margin-bottom: 4px;">
                        <i class="fas fa-building" style="color: #76bc94; margin-right: 6px;"></i>
                        ${suggestion.naam}
                    </div>
                    <div style="font-size: 12px; color: #666;">
                        <div><strong>KVK:</strong> ${suggestion.kvkNummer}</div>
                        ${suggestion.postcode ? `<div><strong>Postcode:</strong> ${suggestion.postcode}</div>` : ''}
                    </div>
                `;
                
                div.addEventListener('click', () => {
                    // For demo purposes, just show a message
                    showStatus(`Bedrijf ${suggestion.naam} geselecteerd`, 'success');
                    container.innerHTML = '';
                });
                
                container.appendChild(div);
            });
        }

        // ========================================
        // MEASUREMENT FUNCTIONALITY
        // ========================================

        let measureMode = null;
        let measurePoints = [];
        let measureLine = null;
        let measurePolygon = null;
        let measureMarkers = [];

        function startMeasuring(mode) {
            clearMeasurements();
            measureMode = mode;
            
            document.querySelectorAll('.measure-panel .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (mode === 'distance') {
                document.getElementById('measureDistance').classList.add('active');
                showStatus('Klik op de kaart om afstand te meten', 'info');
            } else if (mode === 'area') {
                document.getElementById('measureArea').classList.add('active');
                showStatus('Klik op de kaart om oppervlakte te meten', 'info');
            }
            
            map.getContainer().style.cursor = 'crosshair';
        }

        function clearMeasurements() {
            measureMode = null;
            measurePoints = [];
            
            if (measureLine) {
                map.removeLayer(measureLine);
                measureLine = null;
            }
            
            if (measurePolygon) {
                map.removeLayer(measurePolygon);
                measurePolygon = null;
            }
            
            measureMarkers.forEach(marker => map.removeLayer(marker));
            measureMarkers = [];
            
            document.getElementById('measureResults').innerHTML = '';
            document.querySelectorAll('.measure-panel .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            map.getContainer().style.cursor = '';
            showStatus('Metingen gewist', 'info');
        }

        function calculateDistance(points) {
            let totalDistance = 0;
            for (let i = 0; i < points.length - 1; i++) {
                totalDistance += points[i].distanceTo(points[i + 1]);
            }
            return totalDistance;
        }

        function updateMeasureResult() {
            const resultsDiv = document.getElementById('measureResults');
            
            if (measureMode === 'distance' && measurePoints.length > 1) {
                const distance = calculateDistance(measurePoints);
                const distanceText = distance > 1000 ? 
                    `${(distance / 1000).toFixed(2)} km` : 
                    `${distance.toFixed(0)} m`;
                
                resultsDiv.innerHTML = `<div style="background: #e9f7f0; padding: 10px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #76bc94; font-weight: 600;">
                    <i class="fas fa-ruler-horizontal"></i> Afstand: ${distanceText}
                </div>`;
            }
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================

        // Layer controls
        document.getElementById('osmLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.osm);
            } else {
                map.removeLayer(layers.osm);
            }
        });

        document.getElementById('topoLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.topo);
            } else {
                map.removeLayer(layers.topo);
            }
        });

        document.getElementById('bagLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.bag);
                updateInfoBar('BAG panden zichtbaar - klik op gebouwen voor informatie', 'fas fa-building');
            } else {
                map.removeLayer(layers.bag);
                updateInfoBar('BAG panden uitgeschakeld', 'fas fa-exclamation-triangle');
            }
        });

        document.getElementById('luchtfotoLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.luchtfoto);
            } else {
                map.removeLayer(layers.luchtfoto);
            }
        });

        // Search tabs
        document.getElementById('searchTabAddress').addEventListener('click', function() {
            document.getElementById('searchTabAddress').classList.add('active');
            document.getElementById('searchTabKvk').classList.remove('active');
            document.getElementById('searchTabAddress').style.borderBottomColor = '#76bc94';
            document.getElementById('searchTabAddress').style.color = '#76bc94';
            document.getElementById('searchTabKvk').style.borderBottomColor = 'transparent';
            document.getElementById('searchTabKvk').style.color = '#666';
            document.getElementById('addressSearch').style.display = 'block';
            document.getElementById('kvkSearch').style.display = 'none';
            document.getElementById('searchResults').innerHTML = '';
        });

        document.getElementById('searchTabKvk').addEventListener('click', function() {
            document.getElementById('searchTabKvk').classList.add('active');
            document.getElementById('searchTabAddress').classList.remove('active');
            document.getElementById('searchTabKvk').style.borderBottomColor = '#76bc94';
            document.getElementById('searchTabKvk').style.color = '#76bc94';
            document.getElementById('searchTabAddress').style.borderBottomColor = 'transparent';
            document.getElementById('searchTabAddress').style.color = '#666';
            document.getElementById('kvkSearch').style.display = 'block';
            document.getElementById('addressSearch').style.display = 'none';
            document.getElementById('searchResults').innerHTML = '';
        });

        // Search functionality
        document.getElementById('searchBtn').addEventListener('click', searchAddress);

        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            if (query.length >= 3) {
                searchTimeout = setTimeout(searchAddress, 500);
            } else {
                document.getElementById('searchResults').innerHTML = '';
            }
        });

        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                clearTimeout(searchTimeout);
                searchAddress();
            }
        });

        // KVK search
        document.getElementById('kvkSearchBtn').addEventListener('click', async function() {
            const query = document.getElementById('kvkSearchInput').value.trim();
            
            if (!query) {
                showStatus('Voer een KVK nummer of bedrijfsnaam in', 'error');
                return;
            }
            
            if (query.length < OPENKVK_CONFIG.minSearchLength) {
                showStatus(`Voer minimaal ${OPENKVK_CONFIG.minSearchLength} karakters in`, 'error');
                return;
            }
            
            const container = document.getElementById('searchResults');
            container.innerHTML = '<div class="search-result"><i class="fas fa-spinner fa-spin"></i> KVK gegevens ophalen...</div>';
            
            try {
                const suggestions = await searchKvkViaSuggest(query);
                displayKvkSearchResults(suggestions);
                
                if (suggestions.length > 0) {
                    showStatus(`${suggestions.length} bedrijven gevonden`, 'success');
                } else {
                    showStatus('Geen bedrijven gevonden', 'info');
                }
                
            } catch (error) {
                console.error('KVK search error:', error);
                container.innerHTML = `<div class="search-result" style="color: #e74c3c;">Fout: ${error.message}</div>`;
                showStatus('Fout bij zoeken', 'error');
            }
        });

        document.getElementById('kvkSearchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('kvkSearchBtn').click();
            }
        });

        // Measurement controls
        document.getElementById('measureDistance').addEventListener('click', () => {
            startMeasuring('distance');
        });

        document.getElementById('measureArea').addEventListener('click', () => {
            startMeasuring('area');
        });

        document.getElementById('clearMeasurements').addEventListener('click', clearMeasurements);

        // Street View controls
        document.getElementById('streetViewBtn').addEventListener('click', function() {
            if (currentLocationData) {
                openStreetView(
                    currentLocationData.lat, 
                    currentLocationData.lng, 
                    currentLocationData.address
                );
            } else {
                showStatus('Selecteer eerst een locatie op de kaart', 'error');
            }
        });

        document.getElementById('streetViewClose').addEventListener('click', closeStreetView);

        document.getElementById('streetViewOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeStreetView();
            }
        });

        document.getElementById('streetViewFullscreen').addEventListener('click', openStreetViewFullscreen);

        // Info panel controls
        document.getElementById('closeInfo').addEventListener('click', function() {
            document.getElementById('infoPanel').style.display = 'none';
            currentLocationData = null;
        });

        // Map click event handler
        map.on('click', function(e) {
            console.log('Map clicked:', e.latlng);
            
            // Store location for Street View
            currentLocationData = {
                lat: e.latlng.lat,
                lng: e.latlng.lng,
                address: `Locatie: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`
            };
            
            if (!measureMode) {
                // Show info panel with basic location info
                const panel = document.getElementById('infoPanel');
                const content = document.getElementById('infoContent');
                
                content.innerHTML = `
                    <div class="info-item">
                        <div class="info-label">Co√∂rdinaten</div>
                        <div class="info-value">${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Status</div>
                        <div class="info-value">Locatie geselecteerd - Street View beschikbaar</div>
                    </div>
                `;
                
                panel.style.display = 'block';
                updateInfoBar('Locatie geselecteerd - gebruik Street View knop voor straatbeeld', 'fas fa-map-marker-alt');
                
            } else {
                // Handle measurement mode
                measurePoints.push(e.latlng);
                
                const marker = L.circleMarker(e.latlng, {
                    color: '#76bc94',
                    radius: 6
                }).addTo(map);
                measureMarkers.push(marker);
                
                if (measureMode === 'distance') {
                    if (measurePoints.length > 1) {
                        if (measureLine) {
                            map.removeLayer(measureLine);
                        }
                        measureLine = L.polyline(measurePoints, {
                            color: '#76bc94',
                            weight: 3
                        }).addTo(map);
                        updateMeasureResult();
                    }
                }
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (measureMode) {
                    clearMeasurements();
                }
                const overlay = document.getElementById('streetViewOverlay');
                if (overlay.style.display === 'block') {
                    closeStreetView();
                }
            }
        });

        // ========================================
        // INITIALIZATION
        // ========================================

        window.addEventListener('load', function() {
            console.log('‚úÖ WebGIS loaded successfully');
            
            // Initialize BAG layer
            document.getElementById('bagLayer').checked = true;
            map.addLayer(layers.bag);
            
            // Initial message
            setTimeout(() => {
                updateInfoBar('Klik op de kaart voor locatie-informatie en Street View', 'fas fa-info-circle');
            }, 1000);
            
            console.log('üöÄ WebGIS met Street View volledig geladen');
        });

        // Make functions globally available
        window.openStreetView = openStreetView;
        window.initStreetView = initStreetView;
        window.closeStreetView = closeStreetView;

        console.log('‚úÖ WebGIS met Google Street View integration loaded');
    </script>
</body>
</html>
