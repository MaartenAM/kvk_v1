document.getElementById('luchtfotoLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.luchtfoto);
            } else {
                map.removeLayer(layers.luchtfoto);
            }
        });<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGIS Viewer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 280px;
        }

        .search-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 320px;
        }

        .measure-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 280px;
        }

        .btn {
            background: linear-gradient(135deg, #76bc94, #5fa07e);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(118, 188, 148, 0.3);
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: linear-gradient(135deg, #5fa07e, #4d8568);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(118, 188, 148, 0.4);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(118, 188, 148, 0.3);
        }

        .btn.active {
            background: linear-gradient(135deg, #4d8568, #3a6b52);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .search-input:focus {
            outline: none;
            border-color: #76bc94;
            box-shadow: 0 0 0 3px rgba(118, 188, 148, 0.1);
        }

        .search-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .search-result {
            padding: 12px;
            background: #f8f9fa;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .search-result:hover {
            background: #e9f7f0;
            border-left-color: #76bc94;
            transform: translateX(5px);
        }

        .layer-control {
            margin: 10px 0;
        }

        .layer-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .layer-item:hover {
            background: #e9f7f0;
        }

        .layer-checkbox {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            accent-color: #76bc94;
        }

        .measure-result {
            background: #e9f7f0;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #76bc94;
            font-weight: 600;
        }

        .info-panel {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 300px;
            max-width: 400px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .info-item {
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #76bc94;
        }

        .info-label {
            font-weight: 600;
            color: #333;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .info-value {
            color: #555;
            font-size: 14px;
        }

        h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 700;
        }

        .panel-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .panel-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .tooltip {
            background: rgba(51, 51, 51, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="search-container">
        <h3><i class="fas fa-search"></i> Adres zoeken</h3>
        <input type="text" id="searchInput" class="search-input" placeholder="Zoek een adres..." />
        <button id="searchBtn" class="btn btn-small">
            <i class="fas fa-search"></i> Zoeken
        </button>
        <div id="searchResults" class="search-results"></div>
    </div>

    <div class="control-panel">
        <div class="panel-section">
            <h3><i class="fas fa-layer-group"></i> Kaartlagen</h3>
            <div class="layer-control">
                <div class="layer-item">
                    <input type="checkbox" id="osmLayer" class="layer-checkbox" checked>
                    <label for="osmLayer">OpenStreetMap</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="bagLayer" class="layer-checkbox">
                    <label for="bagLayer">BAG Panden</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="topoLayer" class="layer-checkbox">
                    <label for="topoLayer">Topografische kaart</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="luchtfotoLayer" class="layer-checkbox">
                    <label for="luchtfotoLayer">Luchtfoto</label>
                </div>
                <button id="testBackup" class="btn btn-small">
                    <i class="fas fa-sync"></i> Test alternatieve server
                </button>
            </div>
        </div>
    </div>

    <div class="measure-panel">
        <h3><i class="fas fa-ruler"></i> Meettools</h3>
        <div class="panel-section">
            <button id="measureDistance" class="btn">
                <i class="fas fa-ruler-horizontal"></i> Afstand meten
            </button>
            <button id="measureArea" class="btn">
                <i class="fas fa-draw-polygon"></i> Oppervlakte meten
            </button>
            <button id="clearMeasurements" class="btn">
                <i class="fas fa-trash"></i> Wissen
            </button>
        </div>
        <div id="measureResults"></div>
    </div>

    <div class="info-panel" id="infoPanel" style="display: none;">
        <h3><i class="fas fa-info-circle"></i> Pand informatie</h3>
        <div id="infoContent">
            <p>Klik op een pand om informatie te bekijken</p>
        </div>
        <button id="closeInfo" class="btn btn-small">
            <i class="fas fa-times"></i> Sluiten
        </button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        // Debug functie
        function log(message) {
            console.log('WebGIS Debug:', message);
        }

        log('Starting map initialization...');

        // Controleer of Leaflet geladen is
        if (typeof L === 'undefined') {
            alert('Leaflet library niet geladen!');
        } else {
            log('Leaflet loaded successfully');
        }

        // Initialiseer de kaart gecentreerd op Nederland
        let map;
        try {
            map = L.map('map').setView([52.3676, 4.9041], 8);
            log('Map container initialized');
        } catch (error) {
            log('Error initializing map: ' + error.message);
            alert('Fout bij initialiseren kaart: ' + error.message);
        }

        // Kaartlagen
        let osmLayer;
        try {
            osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19,
                subdomains: ['a', 'b', 'c']
            });
            
            osmLayer.on('loading', function() {
                log('OSM tiles are loading...');
            });
            
            osmLayer.on('load', function() {
                log('OSM tiles loaded successfully');
            });
            
            osmLayer.on('tileerror', function(e) {
                log('OSM tile error: ' + e.error);
            });
            
            osmLayer.addTo(map);
            log('OSM layer added to map');
        } catch (error) {
            log('Error loading OSM layer: ' + error.message);
        }

        // Alternatieve OSM server als backup
        const osmBackup = L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors, © OpenStreetMap France',
            maxZoom: 19,
            subdomains: ['a', 'b', 'c']
        });

        const topoLayer = L.tileLayer('https://service.pdok.nl/brt/achtergrondkaart/wmts/v2_0/standaard/EPSG:3857/{z}/{x}/{y}.png', {
            attribution: '© PDOK',
            maxZoom: 19
        });

        const luchtfotoLayer = L.tileLayer('https://service.pdok.nl/hwh/luchtfotorgb/wmts/v1_0/Actueel_orthoHR/EPSG:3857/{z}/{x}/{y}.jpeg', {
            attribution: '© PDOK Luchtfoto',
            maxZoom: 19
        });

        const bagLayer = L.tileLayer.wms('https://service.pdok.nl/lv/bag/wms/v2_0', {
            layers: 'pand',
            format: 'image/png',
            transparent: true,
            attribution: '© BAG'
        });

        // Kaartlagen
        const layers = {
            osm: osmLayer,
            topo: topoLayer,
            luchtfoto: luchtfotoLayer,
            bag: bagLayer
        };

        // Event listeners voor laag checkboxes
        document.getElementById('osmLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.osm);
            } else {
                map.removeLayer(layers.osm);
            }
        });

        document.getElementById('topoLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.topo);
            } else {
                map.removeLayer(layers.topo);
            }
        });

        document.getElementById('bagLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.bag);
            } else {
                map.removeLayer(layers.bag);
            }
        });

        // Test alternatieve server
        document.getElementById('testBackup').addEventListener('click', function() {
            log('Switching to backup OSM server...');
            map.removeLayer(osmLayer);
            osmBackup.addTo(map);
            layers.osm = osmBackup;
        });

        // Zoekfunctionaliteit
        let searchMarker;

        function searchAddress() {
            const query = document.getElementById('searchInput').value;
            if (!query) return;

            const url = `https://api.pdok.nl/bzk/locatieserver/search/v3_1/suggest?q=${encodeURIComponent(query)}&fq=type:adres`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    displaySearchResults(data.response.docs);
                })
                .catch(error => {
                    console.error('Zoekfout:', error);
                });
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';

            if (results.length === 0) {
                container.innerHTML = '<div class="search-result">Geen resultaten gevonden</div>';
                return;
            }

            results.slice(0, 8).forEach(result => {
                const div = document.createElement('div');
                div.className = 'search-result';
                
                // Maak een preview van het adres
                const mainText = document.createElement('div');
                mainText.style.fontWeight = '600';
                mainText.style.color = '#333';
                mainText.textContent = result.weergavenaam;
                
                const subText = document.createElement('div');
                subText.style.fontSize = '12px';
                subText.style.color = '#666';
                subText.style.marginTop = '4px';
                
                // Voeg extra informatie toe indien beschikbaar
                const details = [];
                if (result.gemeentenaam) details.push(result.gemeentenaam);
                if (result.provincienaam) details.push(result.provincienaam);
                if (result.type) details.push(`(${result.type})`);
                subText.textContent = details.join(', ');
                
                div.appendChild(mainText);
                if (subText.textContent) div.appendChild(subText);
                
                div.addEventListener('click', () => {
                    selectSearchResult(result.id);
                    container.innerHTML = '';
                });
                
                container.appendChild(div);
            });
        }

        function selectSearchResult(id) {
            const url = `https://api.pdok.nl/bzk/locatieserver/search/v3_1/lookup?id=${id}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.response.docs.length > 0) {
                        const doc = data.response.docs[0];
                        const coords = doc.centroide_ll.split(' ');
                        const lat = parseFloat(coords[1]);
                        const lng = parseFloat(coords[0]);

                        if (searchMarker) {
                            map.removeLayer(searchMarker);
                        }

                        searchMarker = L.marker([lat, lng]).addTo(map)
                            .bindPopup(doc.weergavenaam)
                            .openPopup();

                        map.setView([lat, lng], 16);
                        document.getElementById('searchResults').innerHTML = '';
                    }
                })
                .catch(error => {
                    console.error('Locatie ophalen fout:', error);
                });
        }

        document.getElementById('searchBtn').addEventListener('click', () => searchAddress());
        
        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchAddress(e.target.value);
            }, 300); // 300ms debounce
        });
        
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                clearTimeout(searchTimeout);
                searchAddress(e.target.value);
            }
        });

        // Meetfunctionaliteit
        let measureMode = null;
        let measurePoints = [];
        let measureLine = null;
        let measurePolygon = null;
        let measureMarkers = [];

        function startMeasuring(mode) {
            clearMeasurements();
            measureMode = mode;
            
            // Update button states
            document.querySelectorAll('.measure-panel .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (mode === 'distance') {
                document.getElementById('measureDistance').classList.add('active');
            } else if (mode === 'area') {
                document.getElementById('measureArea').classList.add('active');
            }
            
            map.getContainer().style.cursor = 'crosshair';
        }

        function clearMeasurements() {
            measureMode = null;
            measurePoints = [];
            
            if (measureLine) {
                map.removeLayer(measureLine);
                measureLine = null;
            }
            
            if (measurePolygon) {
                map.removeLayer(measurePolygon);
                measurePolygon = null;
            }
            
            measureMarkers.forEach(marker => map.removeLayer(marker));
            measureMarkers = [];
            
            document.getElementById('measureResults').innerHTML = '';
            document.querySelectorAll('.measure-panel .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            map.getContainer().style.cursor = '';
        }

        function calculateDistance(points) {
            let totalDistance = 0;
            for (let i = 0; i < points.length - 1; i++) {
                totalDistance += points[i].distanceTo(points[i + 1]);
            }
            return totalDistance;
        }

        function calculateArea(points) {
            if (points.length < 3) return 0;
            
            let area = 0;
            const n = points.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                area += points[i].lat * points[j].lng;
                area -= points[j].lat * points[i].lng;
            }
            
            area = Math.abs(area) / 2;
            return area * 111319.9 * 111319.9 * Math.cos(points[0].lat * Math.PI / 180);
        }

        function updateMeasureResult() {
            const resultsDiv = document.getElementById('measureResults');
            
            if (measureMode === 'distance' && measurePoints.length > 1) {
                const distance = calculateDistance(measurePoints);
                const distanceText = distance > 1000 ? 
                    `${(distance / 1000).toFixed(2)} km` : 
                    `${distance.toFixed(0)} m`;
                
                resultsDiv.innerHTML = `<div class="measure-result">
                    <i class="fas fa-ruler-horizontal"></i> Afstand: ${distanceText}
                </div>`;
            } else if (measureMode === 'area' && measurePoints.length > 2) {
                const area = calculateArea(measurePoints);
                const areaText = area > 10000 ? 
                    `${(area / 10000).toFixed(2)} ha` : 
                    `${area.toFixed(0)} m²`;
                
                resultsDiv.innerHTML = `<div class="measure-result">
                    <i class="fas fa-draw-polygon"></i> Oppervlakte: ${areaText}
                </div>`;
            }
        }

        // Kaart click event voor meten en BAG info
        map.on('click', function(e) {
            // Check of BAG laag actief is en geen meting bezig is
            if (!measureMode && document.getElementById('bagLayer').checked) {
                getBagInfo(e.latlng);
            }
            
            if (!measureMode) return;
            
            measurePoints.push(e.latlng);
            
            // Voeg marker toe
            const marker = L.circleMarker(e.latlng, {
                color: '#76bc94',
                radius: 6
            }).addTo(map);
            measureMarkers.push(marker);
            
            if (measureMode === 'distance') {
                if (measurePoints.length > 1) {
                    if (measureLine) {
                        map.removeLayer(measureLine);
                    }
                    measureLine = L.polyline(measurePoints, {
                        color: '#76bc94',
                        weight: 3
                    }).addTo(map);
                }
                updateMeasureResult();
            } else if (measureMode === 'area') {
                if (measurePoints.length > 2) {
                    if (measurePolygon) {
                        map.removeLayer(measurePolygon);
                    }
                    measurePolygon = L.polygon(measurePoints, {
                        color: '#76bc94',
                        fillColor: '#76bc94',
                        fillOpacity: 0.3
                    }).addTo(map);
                    updateMeasureResult();
                }
            }
        });

        // BAG informatie ophalen
        function getBagInfo(latlng) {
            const point = map.latLngToContainerPoint(latlng);
            const size = map.getSize();
            const bbox = map.getBounds();
            
            const url = `https://service.pdok.nl/lv/bag/wms/v2_0?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&FORMAT=image%2Fpng&TRANSPARENT=true&QUERY_LAYERS=pand&LAYERS=pand&exceptions=application%2Fvnd.ogc.se_inimage&INFO_FORMAT=application%2Fjson&FEATURE_COUNT=50&X=${Math.round(point.x)}&Y=${Math.round(point.y)}&SRS=EPSG%3A4326&STYLES=&WIDTH=${size.x}&HEIGHT=${size.y}&BBOX=${bbox.getSouth()}%2C${bbox.getWest()}%2C${bbox.getNorth()}%2C${bbox.getEast()}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.features && data.features.length > 0) {
                        showBagInfo(data.features[0]);
                    } else {
                        showBagInfo(null);
                    }
                })
                .catch(error => {
                    console.error('BAG WMS fout:', error);
                    showBagInfo(null, 'Fout bij ophalen BAG gegevens');
                });
        }

        // BAG informatie tonen
        function showBagInfo(featureData, errorMessage = null) {
            const panel = document.getElementById('infoPanel');
            const content = document.getElementById('infoContent');
            
            if (errorMessage) {
                content.innerHTML = `<p style="color: #e74c3c;">${errorMessage}</p>`;
            } else if (!featureData) {
                content.innerHTML = '<p>Geen pand gevonden op deze locatie.</p>';
            } else {
                const props = featureData.properties;
                content.innerHTML = `
                    <div class="info-item">
                        <div class="info-label">Pand ID</div>
                        <div class="info-value">${props.pandidentificatie || 'Onbekend'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Bouwjaar</div>
                        <div class="info-value">${props.oorspronkelijkbouwjaar || 'Onbekend'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Status</div>
                        <div class="info-value">${props.status || 'Onbekend'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Oppervlakte</div>
                        <div class="info-value">${props.oppervlakte ? props.oppervlakte + ' m²' : 'Onbekend'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Documentdatum</div>
                        <div class="info-value">${props.documentdatum ? new Date(props.documentdatum).toLocaleDateString() : 'Onbekend'}</div>
                    </div>
                `;
            }
            
            panel.style.display = 'block';
        }

        // Info panel sluiten
        document.getElementById('closeInfo').addEventListener('click', function() {
            document.getElementById('infoPanel').style.display = 'none';
        });

        // Event listeners voor meet buttons
        document.getElementById('measureDistance').addEventListener('click', () => {
            startMeasuring('distance');
        });

        document.getElementById('measureArea').addEventListener('click', () => {
            startMeasuring('area');
        });

        document.getElementById('clearMeasurements').addEventListener('click', clearMeasurements);

        // Escape key om meten te stoppen
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && measureMode) {
                clearMeasurements();
            }
        });
    </script>
</body>
</html>
