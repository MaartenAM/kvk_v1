<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assetmaps met OpenKVK - Geoptimaliseerd</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        /* Verbeterde info bar die altijd zichtbaar is */
        .info-bar {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            background: linear-gradient(135deg, #76bc94, #5fa07e);
            color: white;
            border-radius: 12px;
            padding: 12px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            max-width: 500px;
            min-width: 350px;
            transition: all 0.3s ease;
        }

        .info-bar.error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .info-bar.success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 280px;
        }

        .search-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 320px;
        }

        .measure-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 240px;
        }

        .measure-panel h3 {
            font-size: 16px;
            margin-bottom: 12px;
        }

        .measure-panel .panel-section {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .measure-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .measure-buttons .btn {
            flex: 1;
            min-width: 75px;
            margin: 0 !important;
            padding: 8px 10px !important;
            font-size: 11px !important;
            white-space: nowrap;
        }

        .btn {
            background: linear-gradient(135deg, #76bc94, #5fa07e);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(118, 188, 148, 0.3);
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: linear-gradient(135deg, #5fa07e, #4d8568);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(118, 188, 148, 0.4);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(118, 188, 148, 0.3);
        }

        .btn.active {
            background: linear-gradient(135deg, #4d8568, #3a6b52);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
        }

        /* Loading spinner verbetering */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .search-input:focus {
            outline: none;
            border-color: #76bc94;
            box-shadow: 0 0 0 3px rgba(118, 188, 148, 0.1);
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .search-result {
            padding: 12px;
            background: #f8f9fa;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .search-result:hover {
            background: #e9f7f0;
            border-left-color: #76bc94;
            transform: translateX(5px);
        }

        .layer-control {
            margin: 10px 0;
        }

        .layer-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .layer-item:hover {
            background: #e9f7f0;
        }

        .layer-checkbox {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            accent-color: #76bc94;
        }

        .measure-result {
            background: #e9f7f0;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #76bc94;
            font-weight: 600;
        }

        .info-panel {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 320px;
            max-width: 450px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .kvk-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .kvk-company {
            background: #f8f9fa;
            border-left: 4px solid #76bc94;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
        }

        .kvk-company-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .kvk-company-details {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .kvk-loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .kvk-error {
            background: #fff5f5;
            border-left: 4px solid #e53e3e;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            color: #e53e3e;
            font-size: 12px;
        }

        .info-item {
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #76bc94;
        }

        .info-label {
            font-weight: 600;
            color: #333;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .info-value {
            color: #555;
            font-size: 14px;
        }

        h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 700;
        }

        .panel-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .panel-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .search-tab.active {
            border-bottom-color: #76bc94 !important;
            color: #76bc94 !important;
            font-weight: 600;
        }

        .search-mode {
            transition: all 0.3s ease;
        }

        .kvk-search-result {
            padding: 12px;
            background: #f8f9fa;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #76bc94;
        }

        .kvk-search-result:hover {
            background: #e9f7f0;
            transform: translateX(5px);
        }

        .kvk-result-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .kvk-result-details {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        /* Verbeterde mobile menu */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 70px;
            right: 10px;
            z-index: 1002;
            background: linear-gradient(135deg, #76bc94, #5fa07e);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            font-size: 18px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1003;
            backdrop-filter: blur(2px);
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 320px;
            background: white;
            z-index: 1004;
            overflow-y: auto;
            padding: 20px;
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.2);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .mobile-menu.active {
            transform: translateX(0);
        }

        .mobile-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .mobile-menu-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            transition: color 0.3s ease;
        }

        .mobile-menu-close:hover {
            color: #76bc94;
        }

        .mobile-section {
            margin-bottom: 25px;
        }

        .mobile-section h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: flex !important;
            }

            .control-panel,
            .search-container,
            .measure-panel {
                display: none !important;
            }

            .info-panel {
                position: fixed;
                bottom: 10px;
                left: 10px;
                right: 10px;
                max-width: none;
                min-width: auto;
                width: calc(100vw - 20px);
                max-height: 60vh;
                z-index: 1001;
            }
            
            .info-bar {
                top: 10px !important;
                left: 10px !important;
                right: 70px !important;
                transform: none !important;
                max-width: none !important;
                min-width: auto !important;
                width: calc(100vw - 80px) !important;
                font-size: 13px !important;
                padding: 10px 15px !important;
            }
        }

        @media (max-width: 480px) {
            .info-bar {
                font-size: 12px;
                padding: 8px 12px;
                right: 60px;
                width: calc(100vw - 70px);
            }
            
            .mobile-menu-btn {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
            
            .mobile-menu {
                width: 280px;
            }
        }

        /* Error en warning states */
        .error-state {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .warning-state {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .success-state {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Cache indicator */
        .cache-indicator {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 999;
            display: none;
        }

        /* Improved animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Verbeterde info bar die altijd zichtbaar is -->
    <div class="info-bar" id="infoBar">
        <i class="fas fa-info-circle"></i>
        <span id="infoBarText">WebGIS wordt geladen...</span>
    </div>

    <!-- Mobile menu button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Mobile overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- Mobile menu -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <h3><i class="fas fa-map"></i> WebGIS Menu</h3>
            <button class="mobile-menu-close" id="mobileMenuClose">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="mobile-section">
            <h4><i class="fas fa-search"></i> Zoeken</h4>
            <div class="search-tabs" style="display: flex; margin-bottom: 10px; border-bottom: 1px solid #e0e0e0;">
                <button id="mobileSearchTabAddress" class="search-tab active" style="flex: 1; padding: 12px 8px; border: none; background: none; cursor: pointer; border-bottom: 2px solid #76bc94; color: #76bc94; font-weight: 600;">
                    <i class="fas fa-map-marker-alt"></i> Adres
                </button>
                <button id="mobileSearchTabKvk" class="search-tab" style="flex: 1; padding: 12px 8px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #666;">
                    <i class="fas fa-building"></i> KVK
                </button>
            </div>
            
            <div id="mobileAddressSearch" class="search-mode">
                <input type="text" id="mobileSearchInput" class="search-input" placeholder="Zoek een adres..." />
                <button id="mobileSearchBtn" class="btn btn-small">
                    <i class="fas fa-search"></i> Zoeken
                </button>
            </div>
            
            <div id="mobileKvkSearch" class="search-mode" style="display: none;">
                <input type="text" id="mobileKvkSearchInput" class="search-input" placeholder="KVK nummer of bedrijfsnaam" />
                <button id="mobileKvkSearchBtn" class="btn btn-small">
                    <i class="fas fa-building"></i> Zoek bedrijf
                </button>
            </div>
            
            <div id="mobileSearchResults" class="search-results"></div>
        </div>

        <div class="mobile-section">
            <h4><i class="fas fa-layer-group"></i> Kaartlagen</h4>
            <div class="layer-control">
                <div class="layer-item">
                    <input type="checkbox" id="mobileBagLayer" class="layer-checkbox" checked>
                    <label for="mobileBagLayer">Gebouwinformatie</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="mobileOsmLayer" class="layer-checkbox" checked>
                    <label for="mobileOsmLayer">OpenStreetMap</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="mobileTopoLayer" class="layer-checkbox">
                    <label for="mobileTopoLayer">Topografische kaart</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="mobileLuchtfotoLayer" class="layer-checkbox">
                    <label for="mobileLuchtfotoLayer">Luchtfoto</label>
                </div>
            </div>
        </div>

        <div class="mobile-section">
            <h4><i class="fas fa-ruler"></i> Meettools</h4>
            <div class="measure-buttons">
                <button id="mobileMeasureDistance" class="btn">
                    <i class="fas fa-ruler-horizontal"></i> Afstand
                </button>
                <button id="mobileMeasureArea" class="btn">
                    <i class="fas fa-draw-polygon"></i> Gebied
                </button>
                <button id="mobileClearMeasurements" class="btn">
                    <i class="fas fa-trash"></i> Wis
                </button>
            </div>
            <div id="mobileMeasureResults"></div>
        </div>
    </div>

    <div class="search-container">
        <h3><i class="fas fa-search"></i> Zoeken</h3>
        <div class="search-tabs" style="display: flex; margin-bottom: 10px; border-bottom: 1px solid #e0e0e0;">
            <button id="searchTabAddress" class="search-tab active" style="flex: 1; padding: 8px; border: none; background: none; cursor: pointer; border-bottom: 2px solid #76bc94; color: #76bc94; font-weight: 600;">
                <i class="fas fa-map-marker-alt"></i> Adres
            </button>
            <button id="searchTabKvk" class="search-tab" style="flex: 1; padding: 8px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #666;">
                <i class="fas fa-building"></i> KVK
            </button>
        </div>
        
        <div id="addressSearch" class="search-mode">
            <input type="text" id="searchInput" class="search-input" placeholder="Zoek een adres..." />
            <button id="searchBtn" class="btn btn-small">
                <i class="fas fa-search"></i> Zoeken
            </button>
        </div>
        
        <div id="kvkSearch" class="search-mode" style="display: none;">
            <input type="text" id="kvkSearchInput" class="search-input" placeholder="KVK nummer of bedrijfsnaam" />
            <button id="kvkSearchBtn" class="btn btn-small">
                <i class="fas fa-building"></i> Zoek bedrijf
            </button>
        </div>
        
        <div id="searchResults" class="search-results"></div>
    </div>

    <div class="control-panel">
        <div class="panel-section">
            <h3><i class="fas fa-layer-group"></i> Kaartlagen</h3>
            <div class="layer-control">
                <div class="layer-item">
                    <input type="checkbox" id="bagLayer" class="layer-checkbox" checked>
                    <label for="bagLayer">Gebouwinformatie</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="osmLayer" class="layer-checkbox" checked>
                    <label for="osmLayer">OpenStreetMap</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="topoLayer" class="layer-checkbox">
                    <label for="topoLayer">Topografische kaart</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="luchtfotoLayer" class="layer-checkbox">
                    <label for="luchtfotoLayer">Luchtfoto</label>
                </div>
            </div>
        </div>
    </div>

    <div class="measure-panel">
        <h3><i class="fas fa-ruler"></i> Meettools</h3>
        <div class="measure-buttons">
            <button id="measureDistance" class="btn">
                <i class="fas fa-ruler-horizontal"></i> Afstand
            </button>
            <button id="measureArea" class="btn">
                <i class="fas fa-draw-polygon"></i> Gebied
            </button>
            <button id="clearMeasurements" class="btn">
                <i class="fas fa-trash"></i> Wis
            </button>
        </div>
        <div id="measureResults"></div>
    </div>

    <div class="info-panel" id="infoPanel" style="display: none;">
        <h3><i class="fas fa-info-circle"></i> Locatie informatie</h3>
        <div id="infoContent">
            <p>Klik op een pand om informatie te bekijken</p>
        </div>
        <div id="kvkSection" class="kvk-section" style="display: none;">
            <h4><i class="fas fa-building"></i> Bedrijven (OpenKVK)</h4>
            <div id="kvkContent"></div>
        </div>
        <button id="closeInfo" class="btn btn-small">
            <i class="fas fa-times"></i> Sluiten
        </button>
    </div>

    <!-- Cache indicator -->
    <div class="cache-indicator" id="cacheIndicator">
        <i class="fas fa-database"></i> Cache gebruikt
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        // ========================================
        // VERBETERDE CONFIGURATIE EN CACHE
        // ========================================
        
        const CONFIG = {
            debug: true,
            cache: {
                enabled: true,
                maxAge: 300000, // 5 minuten
                maxSize: 100    // Maximum aantal cache entries
            },
            api: {
                maxRetries: 3,
                timeout: 10000,
                rateLimit: {
                    requests: 5,
                    window: 60000 // 1 minuut
                }
            },
            openkvk: {
                baseUrl: 'https://api.overheid.io/v3/openkvk',
                suggestUrl: 'https://api.overheid.io/v3/suggest/openkvk',
                apiKey: 'af0f54b3b1a1718d8003866dd8fcae6d7d3eff2e726c72b99bbc60756870d455',
                maxSearchResults: 5,
                minSearchLength: 3
            }
        };

        // Verbeterde cache implementatie
        class ApiCache {
            constructor(maxSize = 100, maxAge = 300000) {
                this.cache = new Map();
                this.maxSize = maxSize;
                this.maxAge = maxAge;
            }

            set(key, value) {
                if (this.cache.size >= this.maxSize) {
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }

                this.cache.set(key, {
                    value,
                    timestamp: Date.now()
                });

                this.showCacheIndicator();
            }

            get(key) {
                const item = this.cache.get(key);
                
                if (!item) return null;
                
                if (Date.now() - item.timestamp > this.maxAge) {
                    this.cache.delete(key);
                    return null;
                }

                this.showCacheIndicator();
                return item.value;
            }

            showCacheIndicator() {
                const indicator = document.getElementById('cacheIndicator');
                if (indicator) {
                    indicator.style.display = 'block';
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 2000);
                }
            }

            clear() {
                this.cache.clear();
            }

            size() {
                return this.cache.size;
            }
        }

        // Rate limiter voor API calls
        class RateLimiter {
            constructor(requests = 5, window = 60000) {
                this.requests = requests;
                this.window = window;
                this.calls = [];
            }

            canMakeRequest() {
                const now = Date.now();
                this.calls = this.calls.filter(time => now - time < this.window);
                return this.calls.length < this.requests;
            }

            recordRequest() {
                this.calls.push(Date.now());
            }
        }

        // Initialiseer cache en rate limiter
        const apiCache = new ApiCache(CONFIG.cache.maxSize, CONFIG.cache.maxAge);
        const rateLimiter = new RateLimiter(CONFIG.api.rateLimit.requests, CONFIG.api.rateLimit.window);

        // ========================================
        // VERBETERDE UTILITY FUNCTIONS
        // ========================================
        
        function log(message, level = 'info') {
            if (!CONFIG.debug && level === 'debug') return;
            
            const prefix = `[WebGIS ${level.toUpperCase()}]`;
            switch(level) {
                case 'error':
                    console.error(prefix, message);
                    break;
                case 'warn':
                    console.warn(prefix, message);
                    break;
                case 'debug':
                    console.debug(prefix, message);
                    break;
                default:
                    console.log(prefix, message);
            }
        }

        function updateInfoBar(message, icon = 'fas fa-info-circle', type = 'info') {
            log(`Updating info bar: ${message}`, 'debug');
            
            const infoBar = document.getElementById('infoBar');
            const infoText = document.getElementById('infoBarText');
            
            if (!infoBar || !infoText) {
                log('Info bar elements not found', 'error');
                return;
            }
            
            // Reset classes
            infoBar.className = 'info-bar fade-in';
            
            // Add type-specific class
            if (type === 'error') {
                infoBar.classList.add('error');
            } else if (type === 'success') {
                infoBar.classList.add('success');
            }
            
            const iconElement = infoBar.querySelector('i');
            if (iconElement) {
                iconElement.className = icon;
            }
            
            infoText.textContent = message;
        }

        function showStatus(message, type = 'info', duration = 3000) {
            updateInfoBar(message, 
                type === 'error' ? 'fas fa-exclamation-triangle' : 
                type === 'success' ? 'fas fa-check-circle' : 
                'fas fa-info-circle', 
                type
            );

            // Auto-hide na duration
            setTimeout(() => {
                updateInfoBar('Zoom in en klik op een gebouw voor pand- en bedrijfsinformatie', 'fas fa-building');
            }, duration);
        }

        // Verbeterde error handling
        function handleApiError(error, context = '') {
            log(`API Error in ${context}: ${error.message}`, 'error');
            
            if (error.name === 'TypeError' && error.message.includes('fetch')) {
                showStatus('Netwerkfout - controleer internetverbinding', 'error');
            } else if (error.message.includes('429')) {
                showStatus('Te veel verzoeken - wacht even', 'error');
            } else if (error.message.includes('401') || error.message.includes('403')) {
                showStatus('API authenticatie fout', 'error');
            } else {
                showStatus(`Fout: ${error.message}`, 'error');
            }
        }

        // ========================================
        // VERBETERDE OVERHEID.IO API INTEGRATION
        // ========================================

        async function makeApiRequest(url, options = {}) {
            const cacheKey = url;
            
            // Check cache eerst
            if (CONFIG.cache.enabled) {
                const cached = apiCache.get(cacheKey);
                if (cached) {
                    log('Cache hit for URL: ' + url, 'debug');
                    return cached;
                }
            }

            // Check rate limit
            if (!rateLimiter.canMakeRequest()) {
                throw new Error('Rate limit bereikt - probeer over een minuut opnieuw');
            }

            rateLimiter.recordRequest();

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), CONFIG.api.timeout);

            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                        'ovio-api-key': CONFIG.openkvk.apiKey,
                        ...options.headers
                    }
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // Cache het resultaat
                if (CONFIG.cache.enabled) {
                    apiCache.set(cacheKey, data);
                }

                return data;

            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('Verzoek time-out - probeer opnieuw');
                }
                throw error;
            }
        }

        async function getKvkCompaniesByPandId(pandId) {
            log(`OpenKVK lookup for pand_id: ${pandId}`);
            
            try {
                const url = `${CONFIG.openkvk.baseUrl}?filters[pand_id]=${pandId}&ovio-api-key=${CONFIG.openkvk.apiKey}`;
                const data = await makeApiRequest(url);
                
                let companies = [];
                
                if (data._embedded && data._embedded.bedrijf && data._embedded.bedrijf.length > 0) {
                    log(`Found ${data._embedded.bedrijf.length} companies, fetching detailed info...`);
                    
                    for (const bedrijf of data._embedded.bedrijf) {
                        if (bedrijf._links && bedrijf._links.self && bedrijf._links.self.href) {
                            const detailedCompany = await getKvkCompanyDetails(bedrijf._links.self.href);
                            if (detailedCompany) {
                                companies.push(detailedCompany);
                            }
                        } else {
                            companies.push(parseOverheidApiCompany(bedrijf));
                        }
                    }
                }
                
                return companies;
                
            } catch (error) {
                handleApiError(error, 'getKvkCompaniesByPandId');
                return [];
            }
        }

        async function searchKvkViaSuggest(query) {
            log(`Searching KVK via suggest: ${query}`);
            
            if (!query || query.length < CONFIG.openkvk.minSearchLength) {
                throw new Error(`Minimaal ${CONFIG.openkvk.minSearchLength} karakters vereist`);
            }
            
            try {
                const url = `${CONFIG.openkvk.suggestUrl}/${encodeURIComponent(query)}?ovio-api-key=${CONFIG.openkvk.apiKey}`;
                const data = await makeApiRequest(url);
                
                if (Array.isArray(data) && data.length > 0) {
                    const limitedResults = data.slice(0, CONFIG.openkvk.maxSearchResults);
                    return limitedResults.map(item => parseOverheidSuggestItem(item));
                }
                
                return [];
                
            } catch (error) {
                handleApiError(error, 'searchKvkViaSuggest');
                return [];
            }
        }

        async function getKvkCompanyDetails(link) {
            log(`Getting company details via link: ${link}`);
            
            try {
                const url = `https://api.overheid.io${link}?ovio-api-key=${CONFIG.openkvk.apiKey}`;
                const data = await makeApiRequest(url);
                return parseOverheidApiCompany(data);
                
            } catch (error) {
                handleApiError(error, 'getKvkCompanyDetails');
                return null;
            }
        }

        // Parse functies blijven hetzelfde...
        function parseOverheidApiCompany(bedrijf) {
            return {
                naam: bedrijf.naam || (bedrijf.huidigeHandelsNamen && bedrijf.huidigeHandelsNamen[0]) || 'Onbekend',
                kvknummer: bedrijf.kvknummer || 'Onbekend',
                vestigingsnummer: bedrijf.vestigingsnummer || 'Onbekend',
                hoofdactiviteit: bedrijf.activiteitomschrijving || 'Onbekend',
                status: bedrijf.actief !== false ? 'Actief' : 'Inactief',
                type: bedrijf.inschrijvingstype || 'Onbekend',
                rechtsvorm: bedrijf.rechtsvormOmschrijving || bedrijf.rechtsvormCode || 'Onbekend',
                adres: bedrijf.bezoeklocatie ? {
                    straatnaam: bedrijf.bezoeklocatie.straat,
                    huisnummer: bedrijf.bezoeklocatie.huisnummer,
                    postcode: bedrijf.bezoeklocatie.postcode,
                    plaats: bedrijf.bezoeklocatie.plaats
                } : null,
                handelsnamen: bedrijf.huidigeHandelsNamen || [],
                sbiActiviteiten: bedrijf.activiteiten || [],
                sbiCodes: bedrijf.sbi || [],
                locatie: bedrijf.locatie || null,
                pandId: bedrijf.pand_id || null,
                verblijfsobjectgebruiksdoel: bedrijf.verblijfsobjectgebruiksdoel,
                vboId: bedrijf.vbo_id,
                updatedAt: bedrijf.updated_at,
                isVestiging: bedrijf.vestiging,
                postlocatie: bedrijf.postlocatie,
                slug: bedrijf.slug,
                _source: 'OVERHEID_API'
            };
        }

        function parseOverheidSuggestItem(item) {
            return {
                kvkNummer: item.kvknummer,
                naam: item.naam,
                postcode: item.postcode,
                vestigingsnummer: item.vestigingsnummer,
                link: item.link,
                _source: 'OVERHEID_SUGGEST'
            };
        }

        // ========================================
        // MAP INITIALIZATION
        // ========================================

        let map;
        try {
            map = L.map('map').setView([52.3676, 4.9041], 8);
            log('Map container initialized');
        } catch (error) {
            log('Error initializing map: ' + error.message, 'error');
            showStatus('Fout bij initialiseren kaart', 'error');
        }

        // Kaartlagen
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19,
            subdomains: ['a', 'b', 'c']
        });

        const topoLayer = L.tileLayer('https://service.pdok.nl/brt/achtergrondkaart/wmts/v2_0/standaard/EPSG:3857/{z}/{x}/{y}.png', {
            attribution: '© PDOK',
            maxZoom: 19
        });

        const luchtfotoLayer = L.tileLayer('https://service.pdok.nl/hwh/luchtfotorgb/wmts/v1_0/Actueel_orthoHR/EPSG:3857/{z}/{x}/{y}.jpeg', {
            attribution: '© PDOK Luchtfoto',
            maxZoom: 19
        });

        const bagLayer = L.tileLayer.wms('https://service.pdok.nl/lv/bag/wms/v2_0', {
            layers: 'pand',
            format: 'image/png',
            transparent: true,
            opacity: 0.7,
            attribution: '© BAG',
            zIndex: 1000
        });

        osmLayer.addTo(map);

        const layers = {
            osm: osmLayer,
            topo: topoLayer,
            luchtfoto: luchtfotoLayer,
            bag: bagLayer
        };

        // ========================================
        // MOBILE MENU FUNCTIONALITY
        // ========================================

        function initMobileMenu() {
            log('Initializing mobile menu...');
            
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            const mobileOverlay = document.getElementById('mobileOverlay');
            const mobileMenuClose = document.getElementById('mobileMenuClose');

            if (!mobileMenuBtn || !mobileMenu || !mobileOverlay || !mobileMenuClose) {
                log('Mobile menu elements not found', 'error');
                return;
            }

            function openMobileMenu() {
                log('Opening mobile menu');
                mobileMenu.style.display = 'block';
                mobileOverlay.style.display = 'block';
                setTimeout(() => {
                    mobileMenu.classList.add('active');
                }, 10);
            }

            function closeMobileMenu() {
                log('Closing mobile menu');
                mobileMenu.classList.remove('active');
                setTimeout(() => {
                    mobileMenu.style.display = 'none';
                    mobileOverlay.style.display = 'none';
                }, 300);
            }

            mobileMenuBtn.addEventListener('click', openMobileMenu);
            mobileMenuClose.addEventListener('click', closeMobileMenu);
            mobileOverlay.addEventListener('click', closeMobileMenu);

            setupMobileEventListeners();
        }

        function setupMobileEventListeners() {
            // Mobile search tabs
            document.getElementById('mobileSearchTabAddress').addEventListener('click', function() {
                document.getElementById('mobileSearchTabAddress').classList.add('active');
                document.getElementById('mobileSearchTabKvk').classList.remove('active');
                document.getElementById('mobileAddressSearch').style.display = 'block';
                document.getElementById('mobileKvkSearch').style.display = 'none';
                document.getElementById('mobileSearchResults').innerHTML = '';
            });

            document.getElementById('mobileSearchTabKvk').addEventListener('click', function() {
                document.getElementById('mobileSearchTabKvk').classList.add('active');
                document.getElementById('mobileSearchTabAddress').classList.remove('active');
                document.getElementById('mobileKvkSearch').style.display = 'block';
                document.getElementById('mobileAddressSearch').style.display = 'none';
                document.getElementById('mobileSearchResults').innerHTML = '';
            });

            // Mobile layer controls
            ['mobileBagLayer', 'mobileOsmLayer', 'mobileTopoLayer', 'mobileLuchtfotoLayer'].forEach(id => {
                const mobileControl = document.getElementById(id);
                const desktopId = id.replace('mobile', '').toLowerCase();
                const desktopControl = document.getElementById(desktopId);
                
                if (mobileControl && desktopControl) {
                    mobileControl.addEventListener('change', function() {
                        desktopControl.checked = this.checked;
                        desktopControl.dispatchEvent(new Event('change'));
                    });
                }
            });

            // Mobile search functionality
            document.getElementById('mobileSearchBtn').addEventListener('click', () => {
                const query = document.getElementById('mobileSearchInput').value.trim();
                if (query && query.length >= 3) {
                    searchAddress(query);
                } else {
                    showStatus('Voer minimaal 3 karakters in', 'error');
                }
            });

            document.getElementById('mobileKvkSearchBtn').addEventListener('click', async () => {
                const query = document.getElementById('mobileKvkSearchInput').value.trim();
                if (query && query.length >= CONFIG.openkvk.minSearchLength) {
                    await searchKvk(query);
                } else {
                    showStatus(`Voer minimaal ${CONFIG.openkvk.minSearchLength} karakters in`, 'error');
                }
            });
        }

        // ========================================
        // SEARCH FUNCTIONALITY
        // ========================================

        let searchTimeout;
        let searchMarker;

        async function searchAddress(query = null) {
            const searchQuery = query || document.getElementById('searchInput').value.trim();
            log('Search address function called with query:', searchQuery);
            
            if (!searchQuery || searchQuery.length < 2) {
                document.getElementById('searchResults').innerHTML = '';
                return;
            }

            try {
                const url = `https://api.pdok.nl/bzk/locatieserver/search/v3_1/suggest?q=${encodeURIComponent(searchQuery)}&fq=type:adres&rows=10`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.response && data.response.docs) {
                    displaySearchResults(data.response.docs);
                } else {
                    displaySearchResults([]);
                }
            } catch (error) {
                handleApiError(error, 'searchAddress');
                const container = document.getElementById('searchResults');
                container.innerHTML = `<div class="search-result error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    Fout bij zoeken: ${error.message}
                </div>`;
            }
        }

        async function searchKvk(query) {
            log('Searching KVK:', query);
            const container = document.getElementById('searchResults');
            
            container.innerHTML = '<div class="search-result"><i class="fas fa-spinner loading-spinner"></i> KVK gegevens ophalen...</div>';
            
            try {
                const suggestions = await searchKvkViaSuggest(query);
                displayKvkSearchResults(suggestions);
                
                if (suggestions.length > 0) {
                    showStatus(`${suggestions.length} bedrijven gevonden`, 'success');
                } else {
                    showStatus('Geen bedrijven gevonden', 'info');
                }
                
            } catch (error) {
                handleApiError(error, 'searchKvk');
                container.innerHTML = `<div class="search-result error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    ${error.message}
                </div>`;
            }
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';

            if (!results || results.length === 0) {
                container.innerHTML = '<div class="search-result">Geen resultaten gevonden</div>';
                return;
            }

            results.slice(0, 8).forEach((result, index) => {
                const div = document.createElement('div');
                div.className = 'search-result fade-in';
                
                const mainText = document.createElement('div');
                mainText.style.fontWeight = '600';
                mainText.style.color = '#333';
                mainText.textContent = result.weergavenaam || result.display_name || 'Onbekend adres';
                
                const subText = document.createElement('div');
                subText.style.fontSize = '12px';
                subText.style.color = '#666';
                subText.style.marginTop = '4px';
                
                const details = [];
                if (result.gemeentenaam) details.push(result.gemeentenaam);
                if (result.provincienaam) details.push(result.provincienaam);
                if (result.type) details.push(`(${result.type})`);
                subText.textContent = details.join(', ');
                
                div.appendChild(mainText);
                if (subText.textContent) div.appendChild(subText);
                
                div.addEventListener('click', () => {
                    selectSearchResult(result.id);
                });
                
                container.appendChild(div);
            });
        }

        function displayKvkSearchResults(suggestions) {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';
            
            if (!suggestions || suggestions.length === 0) {
                container.innerHTML = '<div class="search-result">Geen bedrijven gevonden</div>';
                return;
            }
            
            suggestions.forEach((suggestion, index) => {
                const div = document.createElement('div');
                div.className = 'kvk-search-result fade-in';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'kvk-result-name';
                nameDiv.innerHTML = `
                    <i class="fas fa-building" style="color: #76bc94; margin-right: 6px;"></i>
                    ${suggestion.naam}
                `;
                
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'kvk-result-details';
                let detailsHtml = `<div><strong>KVK:</strong> ${suggestion.kvkNummer}</div>`;
                
                if (suggestion.vestigingsnummer) {
                    detailsHtml += `<div><strong>Vestiging:</strong> ${suggestion.vestigingsnummer}</div>`;
                }
                
                if (suggestion.postcode) {
                    detailsHtml += `<div><strong>Postcode:</strong> ${suggestion.postcode}</div>`;
                }
                
                detailsDiv.innerHTML = detailsHtml;
                
                div.appendChild(nameDiv);
                div.appendChild(detailsDiv);
                
                div.addEventListener('click', async () => {
                    await zoomToCompanyFromSuggest(suggestion);
                    container.innerHTML = '';
                });
                
                container.appendChild(div);
            });
        }

        async function selectSearchResult(id) {
            try {
                const url = `https://api.pdok.nl/bzk/locatieserver/search/v3_1/lookup?id=${id}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.response.docs.length > 0) {
                    const doc = data.response.docs[0];
                    
                    let lat, lng;
                    
                    if (doc.centroide_ll) {
                        if (doc.centroide_ll.startsWith('POINT(')) {
                            const coordString = doc.centroide_ll.replace('POINT(', '').replace(')', '');
                            const coords = coordString.split(' ');
                            lng = parseFloat(coords[0]);
                            lat = parseFloat(coords[1]);
                        } else {
                            const coords = doc.centroide_ll.split(' ');
                            lng = parseFloat(coords[0]);
                            lat = parseFloat(coords[1]);
                        }
                    }

                    if (isNaN(lat) || isNaN(lng)) {
                        throw new Error('Ongeldige coördinaten ontvangen');
                    }

                    if (searchMarker) {
                        map.removeLayer(searchMarker);
                    }

                    searchMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'custom-search-marker',
                            html: `<div style="
                                background-color: #76bc94;
                                border: 3px solid white;
                                border-radius: 50%;
                                width: 20px;
                                height: 20px;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                                position: relative;
                            "></div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10],
                            popupAnchor: [0, -10]
                        })
                    }).addTo(map);

                    const popupContent = `
                        <div style="font-family: 'Segoe UI', sans-serif;">
                            <strong style="color: #76bc94;">${doc.weergavenaam}</strong><br>
                            ${doc.gemeentenaam ? `<small>${doc.gemeentenaam}</small>` : ''}
                        </div>
                    `;
                    
                    searchMarker.bindPopup(popupContent).openPopup();

                    map.flyTo([lat, lng], 18, {
                        animate: true,
                        duration: 1.5
                    });
                    
                    document.getElementById('searchResults').innerHTML = '';
                    document.getElementById('searchInput').value = doc.weergavenaam;
                    
                    showStatus('Locatie gevonden en gecentreerd', 'success');
                }
            } catch (error) {
                handleApiError(error, 'selectSearchResult');
            }
        }

        // ========================================
        // BUILDING HIGHLIGHT & BAG INFO
        // ========================================

        let highlightedBuilding = null;

        function highlightBuilding(latlng, pandInfo) {
            log('Creating building highlight at:', latlng);
            
            clearBuildingHighlight();
            
            highlightedBuilding = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'building-highlight-marker',
                    html: `
                        <div style="
                            background: linear-gradient(45deg, #ff4444, #ff6666);
                            border: 4px solid white;
                            border-radius: 50%;
                            width: 40px;
                            height: 40px;
                            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.6);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-weight: bold;
                            font-size: 18px;
                            position: relative;
                            z-index: 9999;
                        ">
                            🏢
                        </div>
                    `,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20],
                    popupAnchor: [0, -20]
                }),
                zIndexOffset: 9999
            }).addTo(map);
            
            highlightedBuilding.bindPopup(`
                <div style="font-family: 'Segoe UI', sans-serif; text-align: center; min-width: 150px;">
                    <div style="color: #ff4444; font-weight: 600; margin-bottom: 5px;">
                        <i class="fas fa-map-marker-alt"></i> Geselecteerd Pand
                    </div>
                    <div style="font-size: 12px; color: #666;">
                        ${pandInfo.identificatie || 'Onbekend'}
                    </div>
                </div>
            `);
            
            updateInfoBar(`Gebouw ${pandInfo.identificatie} geselecteerd`, 'fas fa-building');
        }

        function clearBuildingHighlight() {
            if (highlightedBuilding) {
                map.removeLayer(highlightedBuilding);
                highlightedBuilding = null;
            }
        }

        async function getBagInfo(latlng) {
            log('Getting BAG info for:', latlng);
            
            const point = map.latLngToContainerPoint(latlng);
            const size = map.getSize();
            const bounds = map.getBounds();
            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            
            const wmsUrl = `https://service.pdok.nl/lv/bag/wms/v2_0?` +
                `QUERY_LAYERS=pand&` +
                `INFO_FORMAT=application%2Fjson&` +
                `REQUEST=GetFeatureInfo&` +
                `SERVICE=WMS&` +
                `VERSION=1.3.0&` +
                `FORMAT=image%2Fpng&` +
                `STYLES=&` +
                `TRANSPARENT=true&` +
                `LAYERS=pand&` +
                `FEATURE_COUNT=5&` +
                `I=${Math.round(point.x)}&` +
                `J=${Math.round(point.y)}&` +
                `WIDTH=${size.x}&` +
                `HEIGHT=${size.y}&` +
                `CRS=EPSG%3A4326&` +
                `BBOX=${bbox}`;
            
            try {
                const response = await fetch(wmsUrl);
                const text = await response.text();
                
                if (text.trim().startsWith('<')) {
                    throw new Error('Server returned HTML error page');
                }
                
                const data = JSON.parse(text);
                
                if (data.features && data.features.length > 0) {
                    const pandInfo = data.features[0].properties;
                    showBagInfo(data.features[0]);
                    highlightBuilding(latlng, pandInfo);
                } else {
                    showBagInfo(null, 'Geen pand gevonden - probeer preciezer te klikken');
                    clearBuildingHighlight();
                }
            } catch (error) {
                handleApiError(error, 'getBagInfo');
                showBagInfo(null, `Fout bij ophalen BAG gegevens: ${error.message}`);
                clearBuildingHighlight();
            }
        }

        function showBagInfo(featureData, errorMessage = null) {
            const panel = document.getElementById('infoPanel');
            const content = document.getElementById('infoContent');
            
            if (errorMessage) {
                content.innerHTML = `<div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    ${errorMessage}
                </div>`;
            } else if (!featureData) {
                content.innerHTML = '<div class="warning-state"><i class="fas fa-exclamation-triangle"></i> Geen pand gevonden op deze locatie.</div>';
            } else {
                const props = featureData.properties || {};
                
                let infoHTML = '';
                
                const fieldMapping = {
                    'aantal_verblijfsobjecten': 'Aantal verblijfsobjecten',
                    'bouwjaar': 'Bouwjaar',
                    'oorspronkelijkbouwjaar': 'Oorspronkelijk bouwjaar',
                    'gebruiksdoel': 'Gebruiksdoel',
                    'identificatie': 'Identificatie',
                    'pandidentificatie': 'Pand ID',
                    'oppervlakte_max': 'Oppervlakte max (m²)',
                    'oppervlakte_min': 'Oppervlakte min (m²)',
                    'oppervlakte': 'Oppervlakte (m²)',
                    'status': 'Status',
                    'pandstatus': 'Pand status',
                    'functie': 'Functie'
                };
                
                for (const [key, label] of Object.entries(fieldMapping)) {
                    if (props[key] !== undefined && props[key] !== null && props[key] !== '') {
                        let value = props[key];
                        
                        if (key === 'documentdatum' && value) {
                            value = new Date(value).toLocaleDateString('nl-NL');
                        }
                        
                        infoHTML += `
                            <div class="info-item">
                                <div class="info-label">${label}</div>
                                <div class="info-value">${value}</div>
                            </div>
                        `;
                    }
                }
                
                if (infoHTML === '') {
                    infoHTML = '<div class="info-item">Geen detailgegevens beschikbaar</div>';
                }
                
                content.innerHTML = infoHTML;
            }
            
            panel.style.display = 'block';
            panel.classList.add('fade-in');
        }

        async function getBagAndKvkInfo(latlng) {
            log('Getting BAG and KVK info for:', latlng);
            
            getBagInfo(latlng);
            
            const kvkSection = document.getElementById('kvkSection');
            const kvkContent = document.getElementById('kvkContent');
            
            kvkSection.style.display = 'block';
            kvkContent.innerHTML = '<div class="kvk-loading"><i class="fas fa-spinner loading-spinner"></i> KVK gegevens ophalen...</div>';
            
            try {
                updateInfoBar('Bedrijfsinformatie ophalen...', 'fas fa-spinner loading-spinner');
                const pandInfo = await getBagPandInfo(latlng);
                
                if (pandInfo && pandInfo.identificatie) {
                    const companies = await getKvkCompaniesByPandId(pandInfo.identificatie);
                    displayKvkResults(companies, pandInfo);
                    
                    if (companies && companies.length > 0) {
                        updateInfoBar(`${companies.length} bedrijf${companies.length > 1 ? 'ven' : ''} gevonden in dit pand`, 'fas fa-building', 'success');
                    } else {
                        updateInfoBar('Geen bedrijven gevonden in dit pand', 'fas fa-info-circle');
                    }
                } else {
                    kvkContent.innerHTML = '<div class="kvk-error"><i class="fas fa-exclamation-triangle"></i> Geen pand identificatie gevonden voor KVK lookup</div>';
                    updateInfoBar('Geen pand identificatie gevonden', 'fas fa-exclamation-triangle', 'error');
                }
            } catch (error) {
                handleApiError(error, 'getBagAndKvkInfo');
                kvkContent.innerHTML = `<div class="kvk-error"><i class="fas fa-exclamation-triangle"></i> Fout bij ophalen KVK gegevens: ${error.message}</div>`;
            }
        }

        async function getBagPandInfo(latlng) {
            const point = map.latLngToContainerPoint(latlng);
            const size = map.getSize();
            const bounds = map.getBounds();
            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            
            const wmsUrl = `https://service.pdok.nl/lv/bag/wms/v2_0?` +
                `QUERY_LAYERS=pand&` +
                `INFO_FORMAT=application%2Fjson&` +
                `REQUEST=GetFeatureInfo&` +
                `SERVICE=WMS&` +
                `VERSION=1.3.0&` +
                `FORMAT=image%2Fpng&` +
                `STYLES=&` +
                `TRANSPARENT=true&` +
                `LAYERS=pand&` +
                `FEATURE_COUNT=1&` +
                `I=${Math.round(point.x)}&` +
                `J=${Math.round(point.y)}&` +
                `WIDTH=${size.x}&` +
                `HEIGHT=${size.y}&` +
                `CRS=EPSG%3A4326&` +
                `BBOX=${bbox}`;
            
            try {
                const response = await fetch(wmsUrl);
                const text = await response.text();
                
                if (text.trim().startsWith('<')) {
                    throw new Error('Server returned HTML error page');
                }
                
                const data = JSON.parse(text);
                
                if (data.features && data.features.length > 0) {
                    return data.features[0].properties;
                }
                
                return null;
            } catch (error) {
                log('BAG pand info error: ' + error.message, 'error');
                return null;
            }
        }

        function displayKvkResults(companies, pandInfo) {
            const kvkContent = document.getElementById('kvkContent');
            
            if (!companies || companies.length === 0) {
                kvkContent.innerHTML = `
                    <div style="padding: 12px; text-align: center; color: #666; font-size: 13px;">
                        <i class="fas fa-building" style="color: #ccc; font-size: 24px; margin-bottom: 8px; display: block;"></i>
                        Geen bedrijven gevonden in dit pand
                        ${pandInfo ? `<br><small>Pand ID: ${pandInfo.identificatie}</small>` : ''}
                    </div>
                `;
                return;
            }
            
            let html = '';
            if (pandInfo) {
                html += `<div style="margin-bottom: 12px; padding: 8px; background: #e9f7f0; border-radius: 6px; font-size: 12px; color: #333;">
                    <i class="fas fa-building" style="color: #76bc94;"></i> Pand ID: ${pandInfo.identificatie || 'Onbekend'}
                </div>`;
            }
            
            companies.forEach((company, index) => {
                const isHoofdvestiging = company.type === 'Hoofdvestiging';
                const typeIcon = isHoofdvestiging ? 'fas fa-building' : 'fas fa-store';
                const typeColor = isHoofdvestiging ? '#76bc94' : '#ffa500';
                const typeLabel = company.type || 'Vestiging';
                
                let hoofdactiviteitText = company.hoofdactiviteit;
                if (company.sbiActiviteiten && company.sbiActiviteiten.length > 0) {
                    const hoofdAct = company.sbiActiviteiten.find(act => act.hoofdactiviteit === true);
                    if (hoofdAct && hoofdAct.omschrijving) {
                        hoofdactiviteitText = hoofdAct.omschrijving;
                    }
                }
                
                html += `
                    <div class="kvk-company fade-in">
                        <div class="kvk-company-name">
                            <i class="${typeIcon}" style="color: ${typeColor}; margin-right: 6px;"></i>
                            ${company.naam}
                            <span style="font-size: 10px; background: ${typeColor}; color: white; padding: 2px 6px; border-radius: 10px; margin-left: 8px;">${typeLabel}</span>
                        </div>
                        <div class="kvk-company-details">
                            <div><strong>KVK:</strong> ${company.kvknummer}</div>
                            ${company.vestigingsnummer !== 'Onbekend' ? `<div><strong>Vestiging:</strong> ${company.vestigingsnummer}</div>` : ''}
                            <div><strong>Rechtsvorm:</strong> ${company.rechtsvorm}</div>
                            <div><strong>Status:</strong> <span style="color: ${company.status === 'Actief' ? '#28a745' : '#dc3545'};">${company.status}</span></div>
                            
                            ${company.adres ? `<div style="margin-top: 8px;"><strong>Bezoekadres:</strong><br>${formatAddress(company.adres)}</div>` : ''}
                            
                            <div style="margin-top: 8px;"><strong>Activiteit:</strong><br>${hoofdactiviteitText}</div>
                            
                            ${company.sbiActiviteiten && company.sbiActiviteiten.length > 0 ? `
                                <div style="margin-top: 6px;"><strong>SBI activiteiten:</strong><br>
                                    ${company.sbiActiviteiten.map(act => 
                                        `<span style="font-size: 11px; background: #f1f3f4; padding: 2px 4px; border-radius: 3px; margin: 1px; display: inline-block;">
                                            ${act.code || ''} ${act.omschrijving || ''}${act.hoofdactiviteit ? ' (hoofd)' : ''}
                                        </span>`
                                    ).join('')}
                                </div>
                            ` : ''}
                            
                            ${company.locatie ? `
                                <div style="margin-top: 6px; font-size: 11px; color: #888;">
                                    <strong>Coördinaten:</strong> ${parseFloat(company.locatie.lat).toFixed(5)}, ${parseFloat(company.locatie.lon).toFixed(5)}
                                    <button onclick="zoomToCompanyLocation(${company.locatie.lat}, ${company.locatie.lon}, '${company.naam.replace(/'/g, "\\'")}')" 
                                            style="margin-left: 6px; padding: 2px 6px; font-size: 10px; background: #76bc94; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                        <i class="fas fa-crosshairs"></i> Zoom
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `<div style="margin-top: 12px; padding: 8px; background: #f8f9fa; border-radius: 6px; font-size: 11px; color: #666; text-align: center;">
                <i class="fas fa-info-circle"></i> 
                Gegevens via Overheid.io OpenKVK API
                <br><small>Cache entries: ${apiCache.size()}</small>
            </div>`;
            
            kvkContent.innerHTML = html;
        }

        function formatAddress(adres) {
            if (!adres) return 'Onbekend';
            
            let formatted = '';
            if (adres.straatnaam) {
                formatted += adres.straatnaam;
                if (adres.huisnummer) {
                    formatted += ' ' + adres.huisnummer;
                }
            }
            if (adres.postcode) {
                formatted += ', ' + adres.postcode;
            }
            if (adres.plaats) {
                formatted += ' ' + adres.plaats;
            }
            
            return formatted || 'Onbekend';
        }

        // Global function for zoom to company location
        window.zoomToCompanyLocation = function(lat, lon, companyName) {
            const coords = { lat: parseFloat(lat), lng: parseFloat(lon) };
            
            if (searchMarker) {
                map.removeLayer(searchMarker);
            }
            
            searchMarker = L.marker([coords.lat, coords.lng], {
                icon: L.divIcon({
                    className: 'custom-company-marker',
                    html: `<div style="
                        background-color: #e74c3c;
                        border: 3px solid white;
                        border-radius: 50%;
                        width: 24px;
                        height: 24px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 12px;
                    ">📍</div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12],
                    popupAnchor: [0, -12]
                })
            }).addTo(map);
            
            searchMarker.bindPopup(`
                <div style="font-family: 'Segoe UI', sans-serif; min-width: 200px;">
                    <strong style="color: #e74c3c; font-size: 14px;">${companyName}</strong><br>
                    <small style="color: #666;">Exacte bedrijfslocatie</small>
                </div>
            `).openPopup();
            
            map.flyTo([coords.lat, coords.lng], 19, {
                animate: true,
                duration: 1.5
            });
            
            showStatus(`Gezoomd naar ${companyName}`, 'success');
        };

        async function zoomToCompanyFromSuggest(suggestItem) {
            log('Zooming to company from suggest:', suggestItem);
            
            try {
                const companyDetails = await getKvkCompanyDetails(suggestItem.link);
                
                if (companyDetails && companyDetails.locatie) {
                    const { lat, lon } = companyDetails.locatie;
                    const coords = { lat: parseFloat(lat), lng: parseFloat(lon) };
                    
                    if (!isNaN(coords.lat) && !isNaN(coords.lng)) {
                        zoomToCompany(coords, companyDetails);
                        return;
                    }
                }
                
                // Fallback: geocode via adres
                if (companyDetails && companyDetails.adres) {
                    let adresStr = companyDetails.adres.straatnaam;
                    if (companyDetails.adres.huisnummer) {
                        adresStr += ' ' + companyDetails.adres.huisnummer;
                    }
                    if (companyDetails.adres.plaats) {
                        adresStr += ', ' + companyDetails.adres.plaats;
                    }
                    
                    const coords = await geocodeAddress(adresStr);
                    if (coords) {
                        zoomToCompany(coords, companyDetails);
                        return;
                    }
                }
                
                showStatus('Locatie van bedrijf niet gevonden', 'error');
                
            } catch (error) {
                handleApiError(error, 'zoomToCompanyFromSuggest');
            }
        }

        function zoomToCompany(coords, company) {
            if (searchMarker) {
                map.removeLayer(searchMarker);
            }
            
            searchMarker = L.marker([coords.lat, coords.lng], {
                icon: L.divIcon({
                    className: 'custom-company-marker',
                    html: `<div style="
                        background-color: #76bc94;
                        border: 3px solid white;
                        border-radius: 50%;
                        width: 24px;
                        height: 24px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 12px;
                    ">B</div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12],
                    popupAnchor: [0, -12]
                })
            }).addTo(map);
            
            searchMarker.bindPopup(`
                <div style="font-family: 'Segoe UI', sans-serif; min-width: 200px;">
                    <strong style="color: #76bc94; font-size: 14px;">${company.naam}</strong><br>
                    <small style="color: #666;">KVK: ${company.kvknummer}</small>
                </div>
            `).openPopup();
            
            map.flyTo([coords.lat, coords.lng], 18, {
                animate: true,
                duration: 1.5
            });
        }

        async function geocodeAddress(address) {
            const url = `https://api.pdok.nl/bzk/locatieserver/search/v3_1/suggest?q=${encodeURIComponent(address)}&fq=type:adres&rows=1`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.response && data.response.docs && data.response.docs.length > 0) {
                    const doc = data.response.docs[0];
                    
                    const lookupUrl = `https://api.pdok.nl/bzk/locatieserver/search/v3_1/lookup?id=${doc.id}`;
                    const lookupResponse = await fetch(lookupUrl);
                    const lookupData = await lookupResponse.json();
                    
                    if (lookupData.response.docs.length > 0) {
                        const coordDoc = lookupData.response.docs[0];
                        
                        if (coordDoc.centroide_ll && coordDoc.centroide_ll.startsWith('POINT(')) {
                            const coordString = coordDoc.centroide_ll.replace('POINT(', '').replace(')', '');
                            const coords = coordString.split(' ');
                            const lng = parseFloat(coords[0]);
                            const lat = parseFloat(coords[1]);
                            
                            return { lat, lng, address: coordDoc.weergavenaam };
                        }
                    }
                }
                
                return null;
            } catch (error) {
                log('Geocoding error: ' + error.message, 'error');
                return null;
            }
        }

        // ========================================
        // MEASUREMENT FUNCTIONALITY
        // ========================================

        let measureMode = null;
        let measurePoints = [];
        let measureLine = null;
        let measurePolygon = null;
        let measureMarkers = [];

        function startMeasuring(mode) {
            clearMeasurements();
            measureMode = mode;
            
            document.querySelectorAll('.measure-panel .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (mode === 'distance') {
                document.getElementById('measureDistance').classList.add('active');
                showStatus('Klik op de kaart om afstand te meten', 'info');
            } else if (mode === 'area') {
                document.getElementById('measureArea').classList.add('active');
                showStatus('Klik op de kaart om oppervlakte te meten', 'info');
            }
            
            map.getContainer().style.cursor = 'crosshair';
        }

        function clearMeasurements() {
            if (measureLine) {
                map.removeLayer(measureLine);
                measureLine = null;
            }
            
            if (measurePolygon) {
                map.removeLayer(measurePolygon);
                measurePolygon = null;
            }
            
            measureMarkers.forEach(marker => map.removeLayer(marker));
            measureMarkers = [];
            measurePoints = [];
            measureMode = null;
            
            document.getElementById('measureResults').innerHTML = '';
            document.getElementById('mobileMeasureResults').innerHTML = '';
            
            document.querySelectorAll('.measure-panel .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            map.getContainer().style.cursor = '';
            showStatus('Metingen gewist', 'info');
        }

        function calculateDistance(points) {
            let totalDistance = 0;
            for (let i = 0; i < points.length - 1; i++) {
                totalDistance += points[i].distanceTo(points[i + 1]);
            }
            return totalDistance;
        }

        function calculateArea(points) {
            if (points.length < 3) return 0;
            
            let area = 0;
            const n = points.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                area += points[i].lat * points[j].lng;
                area -= points[j].lat * points[i].lng;
            }
            
            area = Math.abs(area) / 2;
            return area * 111319.9 * 111319.9 * Math.cos(points[0].lat * Math.PI / 180);
        }

        function updateMeasureResult() {
            const resultsDiv = document.getElementById('measureResults');
            const mobileResultsDiv = document.getElementById('mobileMeasureResults');
            
            let resultHtml = '';
            
            if (measureMode === 'distance' && measurePoints.length > 1) {
                const distance = calculateDistance(measurePoints);
                const distanceText = distance > 1000 ? 
                    `${(distance / 1000).toFixed(2)} km` : 
                    `${distance.toFixed(0)} m`;
                
                resultHtml = `<div class="measure-result">
                    <i class="fas fa-ruler-horizontal"></i> Afstand: ${distanceText}
                </div>`;
            } else if (measureMode === 'area' && measurePoints.length > 2) {
                const area = calculateArea(measurePoints);
                const areaText = area > 10000 ? 
                    `${(area / 10000).toFixed(2)} ha` : 
                    `${area.toFixed(0)} m²`;
                
                resultHtml = `<div class="measure-result">
                    <i class="fas fa-draw-polygon"></i> Oppervlakte: ${areaText}
                </div>`;
            }
            
            resultsDiv.innerHTML = resultHtml;
            if (mobileResultsDiv) {
                mobileResultsDiv.innerHTML = resultHtml;
            }
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================

        // Layer control event listeners
        document.getElementById('osmLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.osm);
            } else {
                map.removeLayer(layers.osm);
            }
        });

        document.getElementById('topoLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.topo);
                if (document.getElementById('bagLayer').checked) {
                    layers.bag.bringToFront();
                }
            } else {
                map.removeLayer(layers.topo);
            }
        });

        document.getElementById('bagLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.bag);
                layers.bag.bringToFront();
                updateInfoBar('BAG panden zichtbaar - klik op gebouwen voor informatie', 'fas fa-building');
            } else {
                map.removeLayer(layers.bag);
                updateInfoBar('BAG panden uitgeschakeld - zet aan voor gebouwinformatie', 'fas fa-exclamation-triangle', 'error');
            }
        });

        document.getElementById('luchtfotoLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.luchtfoto);
                if (document.getElementById('bagLayer').checked) {
                    layers.bag.bringToFront();
                }
            } else {
                map.removeLayer(layers.luchtfoto);
            }
        });

        // Search functionality
        document.getElementById('searchTabAddress').addEventListener('click', function() {
            document.getElementById('searchTabAddress').classList.add('active');
            document.getElementById('searchTabKvk').classList.remove('active');
            document.getElementById('addressSearch').style.display = 'block';
            document.getElementById('kvkSearch').style.display = 'none';
            document.getElementById('searchResults').innerHTML = '';
        });

        document.getElementById('searchTabKvk').addEventListener('click', function() {
            document.getElementById('searchTabKvk').classList.add('active');
            document.getElementById('searchTabAddress').classList.remove('active');
            document.getElementById('kvkSearch').style.display = 'block';
            document.getElementById('addressSearch').style.display = 'none';
            document.getElementById('searchResults').innerHTML = '';
        });

        document.getElementById('searchBtn').addEventListener('click', () => {
            searchAddress();
        });

        document.getElementById('kvkSearchBtn').addEventListener('click', async () => {
            const query = document.getElementById('kvkSearchInput').value.trim();
            if (query) {
                await searchKvk(query);
            }
        });

        // Input event listeners with improved debouncing
        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            if (query.length >= 3) {
                searchTimeout = setTimeout(() => {
                    searchAddress();
                }, 500);
            } else {
                document.getElementById('searchResults').innerHTML = '';
            }
        });

        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                clearTimeout(searchTimeout);
                searchAddress();
            }
        });

        document.getElementById('kvkSearchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                if (query) {
                    searchKvk(query);
                }
            }
        });

        // Measurement controls
        document.getElementById('measureDistance').addEventListener('click', () => {
            startMeasuring('distance');
        });

        document.getElementById('measureArea').addEventListener('click', () => {
            startMeasuring('area');
        });

        document.getElementById('clearMeasurements').addEventListener('click', clearMeasurements);

        // Info panel controls
        document.getElementById('closeInfo').addEventListener('click', function() {
            document.getElementById('infoPanel').style.display = 'none';
            document.getElementById('kvkSection').style.display = 'none';
            clearBuildingHighlight();
        });

        // Map event handlers
        map.on('click', function(e) {
            log('Map click event at:', e.latlng);
            
            if (!measureMode && document.getElementById('bagLayer').checked) {
                updateInfoBar('Pand- en bedrijfsinformatie ophalen...', 'fas fa-spinner loading-spinner');
                getBagAndKvkInfo(e.latlng);
            } else if (!measureMode && !document.getElementById('bagLayer').checked) {
                updateInfoBar('Zet BAG panden aan om gebouwinformatie te bekijken', 'fas fa-exclamation-triangle', 'error');
            }
            
            if (!measureMode) return;
            
            measurePoints.push(e.latlng);
            
            const marker = L.circleMarker(e.latlng, {
                color: '#76bc94',
                radius: 6
            }).addTo(map);
            measureMarkers.push(marker);
            
            if (measureMode === 'distance') {
                if (measurePoints.length > 1) {
                    if (measureLine) {
                        map.removeLayer(measureLine);
                    }
                    measureLine = L.polyline(measurePoints, {
                        color: '#76bc94',
                        weight: 3
                    }).addTo(map);
                }
                updateMeasureResult();
            } else if (measureMode === 'area') {
                if (measurePoints.length > 2) {
                    if (measurePolygon) {
                        map.removeLayer(measurePolygon);
                    }
                    measurePolygon = L.polygon(measurePoints, {
                        color: '#76bc94',
                        fillColor: '#76bc94',
                        fillOpacity: 0.3
                    }).addTo(map);
                    updateMeasureResult();
                }
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && measureMode) {
                clearMeasurements();
            }
        });

        // ========================================
        // INITIALIZATION
        // ========================================

        window.addEventListener('load', function() {
            log('WebGIS loaded successfully');
            
            // Initialize mobile menu
            setTimeout(() => {
                initMobileMenu();
            }, 300);
            
            // Auto-enable BAG layer
            document.getElementById('bagLayer').checked = true;
            map.addLayer(layers.bag);
            layers.bag.bringToFront();
            
            // Initial info bar message
            setTimeout(() => {
                updateInfoBar('Zoom in en klik op een gebouw voor pand- en bedrijfsinformatie', 'fas fa-building');
            }, 1000);
            
            log('WebGIS fully loaded and ready');
        });

        // Make functions globally available for console testing
        window.CONFIG = CONFIG;
        window.apiCache = apiCache;
        window.rateLimiter = rateLimiter;
        window.makeApiRequest = makeApiRequest;
        window.searchKvkViaSuggest = searchKvkViaSuggest;
        window.getKvkCompaniesByPandId = getKvkCompaniesByPandId;
        window.log = log;

        log('Improved WebGIS with OpenKVK integration loaded');
    </script>
</body>
</html>
