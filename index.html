<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGIS Viewer met OpenKVK</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 280px;
        }

        .search-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 320px;
        }

        .measure-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 240px;
        }

        .measure-panel h3 {
            font-size: 16px;
            margin-bottom: 12px;
        }

        .measure-panel .panel-section {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .measure-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .measure-buttons .btn {
            flex: 1;
            min-width: 75px;
            margin: 0 !important;
            padding: 8px 10px !important;
            font-size: 11px !important;
            white-space: nowrap;
        }

        .btn {
            background: linear-gradient(135deg, #76bc94, #5fa07e);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(118, 188, 148, 0.3);
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: linear-gradient(135deg, #5fa07e, #4d8568);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(118, 188, 148, 0.4);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(118, 188, 148, 0.3);
        }

        .btn.active {
            background: linear-gradient(135deg, #4d8568, #3a6b52);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .search-input:focus {
            outline: none;
            border-color: #76bc94;
            box-shadow: 0 0 0 3px rgba(118, 188, 148, 0.1);
        }

        .search-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .search-result {
            padding: 12px;
            background: #f8f9fa;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .search-result:hover {
            background: #e9f7f0;
            border-left-color: #76bc94;
            transform: translateX(5px);
        }

        .layer-control {
            margin: 10px 0;
        }

        .layer-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .layer-item:hover {
            background: #e9f7f0;
        }

        .layer-checkbox {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            accent-color: #76bc94;
        }

        .measure-result {
            background: #e9f7f0;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #76bc94;
            font-weight: 600;
        }

        .info-panel {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 320px;
            max-width: 450px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .kvk-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .kvk-company {
            background: #f8f9fa;
            border-left: 4px solid #76bc94;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
        }

        .kvk-company-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .kvk-company-details {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .kvk-loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .kvk-error {
            background: #fff5f5;
            border-left: 4px solid #e53e3e;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            color: #e53e3e;
            font-size: 12px;
        }

        .info-item {
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #76bc94;
        }

        .info-label {
            font-weight: 600;
            color: #333;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .info-value {
            color: #555;
            font-size: 14px;
        }

        h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 700;
        }

        .panel-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .panel-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .search-tab.active {
            border-bottom-color: #76bc94 !important;
            color: #76bc94 !important;
            font-weight: 600;
        }

        .search-mode {
            transition: all 0.3s ease;
        }

        .kvk-search-result {
            padding: 12px;
            background: #f8f9fa;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #76bc94;
        }

        .kvk-search-result:hover {
            background: #e9f7f0;
            transform: translateX(5px);
        }

        .kvk-result-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .kvk-result-details {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .status-indicator {
            position: absolute;
            top: 50px;
            left: 10px;
            z-index: 1001;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 8px 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            color: #666;
            display: none;
        }

        .status-indicator.success {
            border-left: 4px solid #28a745;
            color: #28a745;
        }

        .status-indicator.error {
            border-left: 4px solid #dc3545;
            color: #dc3545;
        }

        .status-indicator.info {
            border-left: 4px solid #17a2b8;
            color: #17a2b8;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="status-indicator" id="statusIndicator">
        <i class="fas fa-info-circle"></i> <span id="statusText"></span>
    </div>

    <div class="search-container">
        <h3><i class="fas fa-search"></i> Zoeken</h3>
        <div class="search-tabs" style="display: flex; margin-bottom: 10px; border-bottom: 1px solid #e0e0e0;">
            <button id="searchTabAddress" class="search-tab active" style="flex: 1; padding: 8px; border: none; background: none; cursor: pointer; border-bottom: 2px solid #76bc94; color: #76bc94; font-weight: 600;">
                <i class="fas fa-map-marker-alt"></i> Adres
            </button>
            <button id="searchTabKvk" class="search-tab" style="flex: 1; padding: 8px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #666;">
                <i class="fas fa-building"></i> KVK
            </button>
        </div>
        
        <div id="addressSearch" class="search-mode">
            <input type="text" id="searchInput" class="search-input" placeholder="Zoek een adres..." />
            <button id="searchBtn" class="btn btn-small">
                <i class="fas fa-search"></i> Zoeken
            </button>
        </div>
        
        <div id="kvkSearch" class="search-mode" style="display: none;">
            <input type="text" id="kvkSearchInput" class="search-input" placeholder="KVK nummer of bedrijfsnaam" />
            <button id="kvkSearchBtn" class="btn btn-small">
                <i class="fas fa-building"></i> Zoek bedrijf
            </button>
        </div>
        
        <div id="searchResults" class="search-results"></div>
    </div>

    <div class="control-panel">
        <div class="panel-section">
            <h3><i class="fas fa-layer-group"></i> Kaartlagen</h3>
            <div class="layer-control">
                <div class="layer-item">
                    <input type="checkbox" id="osmLayer" class="layer-checkbox" checked>
                    <label for="osmLayer">OpenStreetMap</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="bagLayer" class="layer-checkbox">
                    <label for="bagLayer">BAG Panden</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="topoLayer" class="layer-checkbox">
                    <label for="topoLayer">Topografische kaart</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="luchtfotoLayer" class="layer-checkbox">
                    <label for="luchtfotoLayer">Luchtfoto</label>
                </div>
            </div>
        </div>
    </div>

    <div class="measure-panel">
        <h3><i class="fas fa-ruler"></i> Meettools</h3>
        <div class="measure-buttons">
            <button id="measureDistance" class="btn">
                <i class="fas fa-ruler-horizontal"></i> Afstand
            </button>
            <button id="measureArea" class="btn">
                <i class="fas fa-draw-polygon"></i> Gebied
            </button>
            <button id="clearMeasurements" class="btn">
                <i class="fas fa-trash"></i> Wis
            </button>
        </div>
        <div id="measureResults"></div>
    </div>

    <div class="info-panel" id="infoPanel" style="display: none;">
        <h3><i class="fas fa-info-circle"></i> Locatie informatie</h3>
        <div id="infoContent">
            <p>Klik op een pand om informatie te bekijken</p>
        </div>
        <div id="kvkSection" class="kvk-section" style="display: none;">
            <h4><i class="fas fa-building"></i> Bedrijven (OpenKVK)</h4>
            <div id="kvkContent"></div>
        </div>
        <button id="closeInfo" class="btn btn-small">
            <i class="fas fa-times"></i> Sluiten
        </button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        // ========================================
        // DEBUG & UTILITY FUNCTIONS
        // ========================================
        
        function log(message) {
            console.log('WebGIS Debug:', message);
        }

        function showStatus(message, type = 'info') {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            indicator.className = `status-indicator ${type}`;
            text.textContent = message;
            indicator.style.display = 'block';
            
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        log('Starting WebGIS initialization...');

        // ========================================
        // OPENKVK API INTEGRATION
        // ========================================

        // OpenKVK API configuratie (CORS-vriendelijk, geen API key nodig!)
        const OPENKVK_CONFIG = {
            baseUrl: 'https://api.overheid.io/openkvk',
            suggestUrl: 'https://api.overheid.io/suggest/openkvk'
        };

        // Haal bedrijven op via OpenKVK API - adres zoeken
        async function getKvkCompanies(postcode, huisnummer) {
            console.log('OpenKVK API lookup for:', postcode, huisnummer);
            
            try {
                const cleanPostcode = postcode.replace(/\s/g, '');
                
                // Zoek op postcode + huisnummer
                let searchUrl = `${OPENKVK_CONFIG.baseUrl}?query=${encodeURIComponent(cleanPostcode + ' ' + huisnummer)}&queryfields[]=postcode&queryfields[]=bezoeklocatie.huisnummer&queryfields[]=bezoeklocatie.postcode&size=20`;
                
                console.log('OpenKVK API URL:', searchUrl);
                
                let response = await fetch(searchUrl, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                console.log('OpenKVK API response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`OpenKVK API error: ${response.status} ${response.statusText}`);
                }
                
                let data = await response.json();
                console.log('OpenKVK API data received:', data);
                
                let companies = [];
                
                if (data._embedded && data._embedded.bedrijf && data._embedded.bedrijf.length > 0) {
                    // Filter resultaten op exacte postcode en huisnummer match
                    companies = data._embedded.bedrijf.filter(bedrijf => {
                        if (!bedrijf.bezoeklocatie) return false;
                        
                        const bedrijfPostcode = bedrijf.bezoeklocatie.postcode?.replace(/\s/g, '').toLowerCase();
                        const bedrijfHuisnummer = String(bedrijf.bezoeklocatie.huisnummer || '');
                        const zoekPostcode = cleanPostcode.toLowerCase();
                        const zoekHuisnummer = String(huisnummer);
                        
                        return bedrijfPostcode === zoekPostcode && bedrijfHuisnummer === zoekHuisnummer;
                    }).map(bedrijf => parseOpenKvkBedrijf(bedrijf));
                }
                
                // Als geen exacte matches, probeer bredere zoekopdracht
                if (companies.length === 0) {
                    console.log('No exact matches, trying broader search...');
                    searchUrl = `${OPENKVK_CONFIG.baseUrl}?query=${encodeURIComponent(cleanPostcode)}&queryfields[]=postcode&queryfields[]=bezoeklocatie.postcode&size=50`;
                    
                    response = await fetch(searchUrl);
                    if (response.ok) {
                        data = await response.json();
                        if (data._embedded && data._embedded.bedrijf) {
                            companies = data._embedded.bedrijf.filter(bedrijf => {
                                return bedrijf.bezoeklocatie && 
                                       String(bedrijf.bezoeklocatie.huisnummer || '') === String(huisnummer);
                            }).map(bedrijf => parseOpenKvkBedrijf(bedrijf));
                        }
                    }
                }
                
                console.log(`Found ${companies.length} companies at ${postcode} ${huisnummer}`);
                return companies;
                
            } catch (error) {
                console.error('OpenKVK API error:', error);
                return getMockKvkCompanies(postcode, huisnummer);
            }
        }

        // KVK nummer/naam zoeken via OpenKVK
        async function searchKvkNumber(query) {
            console.log('=== SEARCHING KVK VIA OPENKVK ===');
            console.log('Input query:', query);
            
            if (!query || query.length < 2) {
                console.log('❌ Query too short:', query?.length);
                return [];
            }
            
            try {
                let searchUrl;
                
                // Check of het een KVK nummer is (alleen cijfers, 8 karakters)
                if (/^\d{8}$/.test(query)) {
                    searchUrl = `${OPENKVK_CONFIG.baseUrl}?query=${query}&queryfields[]=kvkNummer&queryfields[]=kvknummer&size=10`;
                } else {
                    // Zoek op naam
                    searchUrl = `${OPENKVK_CONFIG.baseUrl}?query=${encodeURIComponent(query)}&queryfields[]=naam&queryfields[]=handelsnaam&queryfields[]=huidigeHandelsNamen&size=20`;
                }
                
                console.log('🔍 OpenKVK API URL:', searchUrl);
                
                const response = await fetch(searchUrl, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                console.log('📡 Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`OpenKVK API error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📊 OpenKVK response data:', data);
                
                if (data._embedded && data._embedded.bedrijf && data._embedded.bedrijf.length > 0) {
                    console.log(`✅ Found ${data._embedded.bedrijf.length} companies from OpenKVK API`);
                    
                    const processedCompanies = data._embedded.bedrijf.map((bedrijf, index) => {
                        console.log(`Processing company ${index}:`, bedrijf.naam);
                        return parseOpenKvkBedrijfForSearch(bedrijf);
                    });
                    
                    console.log('✅ Returning OpenKVK API results:', processedCompanies.length, 'companies');
                    return processedCompanies;
                } else {
                    console.log('❌ No companies found in OpenKVK API response');
                    return [];
                }
                
            } catch (error) {
                console.log('❌ OpenKVK API call failed:', error);
                showStatus('Fout bij zoeken in KVK database', 'error');
                return [];
            }
        }

        // Parse OpenKVK bedrijf data voor adres lookup
        function parseOpenKvkBedrijf(bedrijf) {
            let adresInfo = null;
            if (bedrijf.bezoeklocatie) {
                const bl = bedrijf.bezoeklocatie;
                adresInfo = {
                    straatnaam: bl.straat,
                    huisnummer: bl.huisnummer,
                    postcode: bl.postcode,
                    plaats: bl.plaats,
                    land: bl.land || 'Nederland'
                };
            }
            
            return {
                naam: bedrijf.naam || bedrijf.handelsnaam || (bedrijf.huidigeHandelsNamen && bedrijf.huidigeHandelsNamen[0]) || 'Onbekend',
                kvknummer: bedrijf.kvkNummer || bedrijf.kvknummer,
                vestigingsnummer: bedrijf.vestigingsnummer,
                hoofdactiviteit: bedrijf.activiteitomschrijving || 
                               (bedrijf.activiteiten && bedrijf.activiteiten[0] ? bedrijf.activiteiten[0].omschrijving : null),
                status: bedrijf.actief !== false ? 'Actief' : 'Inactief',
                type: determineVestigingType(bedrijf),
                rechtsvorm: bedrijf.rechtsvormOmschrijving,
                adres: adresInfo,
                website: bedrijf.website,
                handelsnamen: bedrijf.huidigeHandelsNamen || [],
                sbiActiviteiten: bedrijf.sbi ? bedrijf.sbi.map(code => ({ sbiCode: code })) : [],
                _source: 'OPENKVK_API'
            };
        }

        // Parse OpenKVK bedrijf data voor KVK search
        function parseOpenKvkBedrijfForSearch(bedrijf) {
            let adresInfo = null;
            if (bedrijf.bezoeklocatie) {
                const bl = bedrijf.bezoeklocatie;
                adresInfo = {
                    straatnaam: bl.straat,
                    huisnummer: bl.huisnummer,
                    postcode: bl.postcode,
                    plaats: bl.plaats,
                    type: 'bezoekadres'
                };
            }
            
            return {
                kvkNummer: bedrijf.kvkNummer || bedrijf.kvknummer,
                naam: bedrijf.naam || bedrijf.handelsnaam || (bedrijf.huidigeHandelsNamen && bedrijf.huidigeHandelsNamen[0]) || 'Onbekend',
                type: determineVestigingType(bedrijf),
                adres: adresInfo,
                rechtsvorm: bedrijf.rechtsvormOmschrijving,
                hoofdactiviteit: bedrijf.activiteitomschrijving,
                status: bedrijf.actief !== false ? 'Actief' : 'Inactief',
                website: bedrijf.website,
                handelsnamen: bedrijf.huidigeHandelsNamen || [],
                _source: 'OPENKVK_API'
            };
        }

        // Bepaal vestiging type
        function determineVestigingType(bedrijf) {
            if (bedrijf.vestiging === true) return 'vestiging';
            if (bedrijf.vestiging === false) return 'rechtspersoon';
            if (bedrijf.subdossiernummer === '0000') return 'rechtspersoon';
            return 'vestiging';
        }

        // Fallback mock data
        function getMockKvkCompanies(postcode, huisnummer) {
            console.log('Using mock KVK data for:', postcode, huisnummer);
            
            const mockData = {
                '1012': [{
                    naam: 'Amsterdam Tech Solutions B.V.',
                    kvknummer: '12345678',
                    hoofdactiviteit: 'Softwareontwikkeling',
                    vestigingsnummer: '000012345678',
                    status: 'Actief',
                    type: 'rechtspersoon'
                }],
                '7323': [{
                    naam: 'Apeldoorn Innovation Hub',
                    kvknummer: '23456789',
                    hoofdactiviteit: 'Zakelijke dienstverlening',
                    vestigingsnummer: '000023456789',
                    status: 'Actief',
                    type: 'rechtspersoon'
                }]
            };
            
            const postcodeKey = postcode.substring(0, 4);
            return mockData[postcodeKey] || [];
        }

        // Test OpenKVK API connectie
        async function testKvkApi() {
            console.log('=== TESTING OPENKVK API CONNECTION ===');
            
            try {
                const testUrl = `${OPENKVK_CONFIG.baseUrl}?query=downsized&size=1`;
                console.log('Test URL:', testUrl);
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                console.log('Test response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ OPENKVK API CONNECTION SUCCESS');
                    console.log('Found companies:', data._embedded?.bedrijf?.length || 0);
                    showStatus('OpenKVK API verbinding succesvol', 'success');
                    return data;
                } else {
                    console.log('❌ OpenKVK API test failed:', response.status);
                    showStatus('OpenKVK API test gefaald', 'error');
                    return null;
                }
                
            } catch (error) {
                console.log('❌ OPENKVK API CONNECTION FAILED:', error.message);
                showStatus('OpenKVK API niet bereikbaar', 'error');
                return null;
            }
        }

        // ========================================
        // MAP INITIALIZATION
        // ========================================

        if (typeof L === 'undefined') {
            alert('Leaflet library niet geladen!');
        } else {
            log('Leaflet loaded successfully');
        }

        let map;
        try {
            map = L.map('map').setView([52.3676, 4.9041], 8);
            log('Map container initialized');
            showStatus('Kaart geladen', 'success');
        } catch (error) {
            log('Error initializing map: ' + error.message);
            alert('Fout bij initialiseren kaart: ' + error.message);
        }

        // Kaartlagen
        let osmLayer;
        try {
            osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19,
                subdomains: ['a', 'b', 'c']
            });
            
            osmLayer.on('loading', function() {
                log('OSM tiles are loading...');
            });
            
            osmLayer.on('load', function() {
                log('OSM tiles loaded successfully');
            });
            
            osmLayer.on('tileerror', function(e) {
                log('OSM tile error: ' + e.error);
            });
            
            osmLayer.addTo(map);
            log('OSM layer added to map');
        } catch (error) {
            log('Error loading OSM layer: ' + error.message);
        }

        const topoLayer = L.tileLayer('https://service.pdok.nl/brt/achtergrondkaart/wmts/v2_0/standaard/EPSG:3857/{z}/{x}/{y}.png', {
            attribution: '© PDOK',
            maxZoom: 19
        });

        const luchtfotoLayer = L.tileLayer('https://service.pdok.nl/hwh/luchtfotorgb/wmts/v1_0/Actueel_orthoHR/EPSG:3857/{z}/{x}/{y}.jpeg', {
            attribution: '© PDOK Luchtfoto',
            maxZoom: 19
        });

        const bagLayer = L.tileLayer.wms('https://service.pdok.nl/lv/bag/wms/v2_0', {
            layers: 'pand',
            format: 'image/png',
            transparent: true,
            attribution: '© BAG'
        });

        // Kaartlagen object
        const layers = {
            osm: osmLayer,
            topo: topoLayer,
            luchtfoto: luchtfotoLayer,
            bag: bagLayer
        };

        // ========================================
        // SEARCH FUNCTIONALITY
        // ========================================

        let searchTimeout;
        let searchMarker;

        function searchAddress() {
            const query = document.getElementById('searchInput').value.trim();
            console.log('Search function called with query:', query);
            
            if (!query || query.length < 2) {
                console.log('Query too short, clearing results');
                document.getElementById('searchResults').innerHTML = '';
                return;
            }

            const url = `https://api.pdok.nl/bzk/locatieserver/search/v3_1/suggest?q=${encodeURIComponent(query)}&fq=type:adres&rows=10`;
            console.log('Search URL:', url);

            fetch(url)
                .then(response => {
                    console.log('Search response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Search data received:', data);
                    if (data.response && data.response.docs) {
                        console.log('Found', data.response.docs.length, 'results');
                        displaySearchResults(data.response.docs);
                    } else {
                        console.log('No docs in response');
                        displaySearchResults([]);
                    }
                })
                .catch(error => {
                    console.error('Zoekfout:', error);
                    const container = document.getElementById('searchResults');
                    container.innerHTML = `<div class="search-result" style="color: #e74c3c;">Fout bij zoeken: ${error.message}</div>`;
                });
        }

        function displaySearchResults(results) {
            console.log('Displaying search results:', results);
            const container = document.getElementById('searchResults');
            
            if (!container) {
                console.error('Search results container not found!');
                return;
            }
            
            container.innerHTML = '';

            if (!results || results.length === 0) {
                container.innerHTML = '<div class="search-result">Geen resultaten gevonden</div>';
                return;
            }

            results.slice(0, 8).forEach((result, index) => {
                console.log(`Creating result ${index}:`, result);
                
                const div = document.createElement('div');
                div.className = 'search-result';
                
                const mainText = document.createElement('div');
                mainText.style.fontWeight = '600';
                mainText.style.color = '#333';
                mainText.textContent = result.weergavenaam || result.display_name || 'Onbekend adres';
                
                const subText = document.createElement('div');
                subText.style.fontSize = '12px';
                subText.style.color = '#666';
                subText.style.marginTop = '4px';
                
                const details = [];
                if (result.gemeentenaam) details.push(result.gemeentenaam);
                if (result.provincienaam) details.push(result.provincienaam);
                if (result.type) details.push(`(${result.type})`);
                subText.textContent = details.join(', ');
                
                div.appendChild(mainText);
                if (subText.textContent) div.appendChild(subText);
                
                div.addEventListener('click', () => {
                    console.log('Search result clicked:', result);
                    selectSearchResult(result.id);
                });
                
                container.appendChild(div);
            });
        }

        function selectSearchResult(id) {
            const url = `https://api.pdok.nl/bzk/locatieserver/search/v3_1/lookup?id=${id}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.response.docs.length > 0) {
                        const doc = data.response.docs[0];
                        console.log('Search result doc:', doc);
                        
                        let lat, lng;
                        
                        if (doc.centroide_ll) {
                            console.log('Raw centroide_ll:', doc.centroide_ll);
                            
                            if (doc.centroide_ll.startsWith('POINT(')) {
                                const coordString = doc.centroide_ll.replace('POINT(', '').replace(')', '');
                                const coords = coordString.split(' ');
                                lng = parseFloat(coords[0]);
                                lat = parseFloat(coords[1]);
                            } else {
                                const coords = doc.centroide_ll.split(' ');
                                lng = parseFloat(coords[0]);
                                lat = parseFloat(coords[1]);
                            }
                        }

                        console.log('Parsed coordinates:', { lat, lng });

                        if (isNaN(lat) || isNaN(lng)) {
                            console.error('Ongeldige coördinaten na parsing. Raw data:', doc.centroide_ll);
                            return;
                        }

                        if (searchMarker) {
                            map.removeLayer(searchMarker);
                        }

                        searchMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'custom-search-marker',
                                html: `<div style="
                                    background-color: #76bc94;
                                    border: 3px solid white;
                                    border-radius: 50%;
                                    width: 20px;
                                    height: 20px;
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                                    position: relative;
                                "></div>
                                <div style="
                                    position: absolute;
                                    top: 20px;
                                    left: 50%;
                                    transform: translateX(-50%);
                                    width: 0;
                                    height: 0;
                                    border-left: 6px solid transparent;
                                    border-right: 6px solid transparent;
                                    border-top: 8px solid #76bc94;
                                    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
                                "></div>`,
                                iconSize: [20, 28],
                                iconAnchor: [10, 28],
                                popupAnchor: [0, -28]
                            })
                        }).addTo(map);

                        const popupContent = `
                            <div style="font-family: 'Segoe UI', sans-serif;">
                                <strong style="color: #76bc94;">${doc.weergavenaam}</strong><br>
                                ${doc.gemeentenaam ? `<small>${doc.gemeentenaam}</small>` : ''}
                            </div>
                        `;
                        
                        searchMarker.bindPopup(popupContent).openPopup();

                        map.flyTo([lat, lng], 18, {
                            animate: true,
                            duration: 1.5
                        });
                        
                        document.getElementById('searchResults').innerHTML = '';
                        document.getElementById('searchInput').value = doc.weergavenaam;
                        
                        console.log('Zoom completed to:', lat, lng);
                    }
                })
                .catch(error => {
                    console.error('Locatie ophalen fout:', error);
                });
        }

        // Geocode adres naar coördinaten
        async function geocodeAddress(address) {
            const url = `https://api.pdok.nl/bzk/locatieserver/search/v3_1/suggest?q=${encodeURIComponent(address)}&fq=type:adres&rows=1`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.response && data.response.docs && data.response.docs.length > 0) {
                    const doc = data.response.docs[0];
                    
                    const lookupUrl = `https://api.pdok.nl/bzk/locatieserver/search/v3_1/lookup?id=${doc.id}`;
                    const lookupResponse = await fetch(lookupUrl);
                    const lookupData = await lookupResponse.json();
                    
                    if (lookupData.response.docs.length > 0) {
                        const coordDoc = lookupData.response.docs[0];
                        
                        if (coordDoc.centroide_ll.startsWith('POINT(')) {
                            const coordString = coordDoc.centroide_ll.replace('POINT(', '').replace(')', '');
                            const coords = coordString.split(' ');
                            const lng = parseFloat(coords[0]);
                            const lat = parseFloat(coords[1]);
                            
                            return { lat, lng, address: coordDoc.weergavenaam };
                        }
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        // Zoom naar bedrijf
        function zoomToCompany(coords, company) {
            if (searchMarker) {
                map.removeLayer(searchMarker);
            }
            
            searchMarker = L.marker([coords.lat, coords.lng], {
                icon: L.divIcon({
                    className: 'custom-company-marker',
                    html: `<div style="
                        background-color: #76bc94;
                        border: 3px solid white;
                        border-radius: 50%;
                        width: 24px;
                        height: 24px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        position: relative;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 12px;
                    ">B</div>
                    <div style="
                        position: absolute;
                        top: 24px;
                        left: 50%;
                        transform: translateX(-50%);
                        width: 0;
                        height: 0;
                        border-left: 6px solid transparent;
                        border-right: 6px solid transparent;
                        border-top: 8px solid #76bc94;
                        filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
                    "></div>`,
                    iconSize: [24, 32],
                    iconAnchor: [12, 32],
                    popupAnchor: [0, -32]
                })
            }).addTo(map);
            
            const popupContent = `
                <div style="font-family: 'Segoe UI', sans-serif; min-width: 200px;">
                    <strong style="color: #76bc94; font-size: 14px;">${company.naam}</strong><br>
                    <small style="color: #666;">KVK: ${company.kvkNummer}</small><br>
                    ${company.rechtsvorm ? `<small style="color: #666;">${company.rechtsvorm}</small><br>` : ''}
                    ${coords.address ? `<small style="color: #888;">${coords.address}</small>` : ''}
                </div>
            `;
            
            searchMarker.bindPopup(popupContent).openPopup();
            
            map.flyTo([coords.lat, coords.lng], 18, {
                animate: true,
                duration: 1.5
            });
        }

        // ========================================
        // KVK SEARCH DISPLAY FUNCTIONS
        // ========================================

        function displayKvkSearchResults(companies) {
            console.log('Displaying KVK search results:', companies);
            const container = document.getElementById('searchResults');
            
            if (!container) {
                console.error('Search results container not found!');
                return;
            }
            
            container.innerHTML = '';
            
            if (!companies || companies.length === 0) {
                container.innerHTML = '<div class="search-result">Geen bedrijven gevonden</div>';
                return;
            }
            
            companies.forEach((company, index) => {
                console.log(`Creating KVK result ${index}:`, company);
                
                const div = document.createElement('div');
                div.className = 'kvk-search-result';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'kvk-result-name';
                nameDiv.innerHTML = `
                    <i class="fas fa-building" style="color: #76bc94; margin-right: 6px;"></i>
                    ${company.naam}
                `;
                
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'kvk-result-details';
                let detailsHtml = `<div><strong>KVK:</strong> ${company.kvkNummer}</div>`;
                
                if (company.type) {
                    const typeLabel = company.type === 'rechtspersoon' ? 'Hoofdvestiging' : 'Vestiging';
                    detailsHtml += `<div><strong>Type:</strong> ${typeLabel}</div>`;
                }
                
                if (company.rechtsvorm) {
                    detailsHtml += `<div><strong>Rechtsvorm:</strong> ${company.rechtsvorm}</div>`;
                }
                
                if (company.hoofdactiviteit) {
                    detailsHtml += `<div><strong>Hoofdactiviteit:</strong> ${company.hoofdactiviteit}</div>`;
                }
                
                if (company.adres) {
                    let adresStr = '';
                    if (company.adres.straatnaam) {
                        adresStr += company.adres.straatnaam;
                        if (company.adres.huisnummer) {
                            adresStr += ' ' + company.adres.huisnummer;
                        }
                        adresStr += ', ';
                    }
                    if (company.adres.postcode) {
                        adresStr += company.adres.postcode + ' ';
                    }
                    if (company.adres.plaats) {
                        adresStr += company.adres.plaats;
                    }
                    
                    if (adresStr) {
                        detailsHtml += `<div><strong>Adres:</strong> ${adresStr}</div>`;
                    }
                }
                
                detailsDiv.innerHTML = detailsHtml;
                
                div.appendChild(nameDiv);
                div.appendChild(detailsDiv);
                
                div.addEventListener('click', async () => {
                    console.log('KVK search result clicked:', company);
                    
                    if (company.adres && company.adres.straatnaam && company.adres.plaats) {
                        let adresStr = company.adres.straatnaam;
                        if (company.adres.huisnummer) {
                            adresStr += ' ' + company.adres.huisnummer;
                        }
                        adresStr += ', ' + company.adres.plaats;
                        
                        console.log('Geocoding address:', adresStr);
                        
                        try {
                            const coords = await geocodeAddress(adresStr);
                            if (coords) {
                                zoomToCompany(coords, company);
                            } else {
                                showStatus('Adres niet gevonden op de kaart', 'error');
                            }
                        } catch (error) {
                            console.error('Geocoding error:', error);
                            showStatus('Fout bij zoeken naar adres', 'error');
                        }
                    } else {
                        showStatus('Geen volledig adres beschikbaar', 'error');
                    }
                    
                    container.innerHTML = '';
                });
                
                container.appendChild(div);
            });
            
            // Voeg bron informatie toe
            const sourceDiv = document.createElement('div');
            sourceDiv.style.cssText = 'margin-top: 10px; padding: 8px; background: #f0f0f0; border-radius: 6px; font-size: 11px; text-align: center; color: #666;';
            sourceDiv.innerHTML = '<i class="fas fa-info-circle"></i> Gegevens via OpenKVK API';
            container.appendChild(sourceDiv);
        }

        function displayKvkResults(companies, address) {
            const kvkContent = document.getElementById('kvkContent');
            
            if (!companies || companies.length === 0) {
                kvkContent.innerHTML = `
                    <div style="padding: 12px; text-align: center; color: #666; font-size: 13px;">
                        <i class="fas fa-building" style="color: #ccc; font-size: 24px; margin-bottom: 8px; display: block;"></i>
                        Geen bedrijven gevonden op dit adres
                        ${address ? `<br><small>${address.volledigAdres}</small>` : ''}
                    </div>
                `;
                return;
            }
            
            let html = '';
            if (address) {
                html += `<div style="margin-bottom: 12px; padding: 8px; background: #e9f7f0; border-radius: 6px; font-size: 12px; color: #333;">
                    <i class="fas fa-map-marker-alt" style="color: #76bc94;"></i> ${address.volledigAdres}
                </div>`;
            }
            
            companies.forEach((company, index) => {
                const isHoofdvestiging = company.type === 'rechtspersoon' || company.type === 'Hoofdvestiging';
                const typeIcon = isHoofdvestiging ? 'fas fa-building' : 'fas fa-store';
                const typeColor = isHoofdvestiging ? '#76bc94' : '#ffa500';
                const typeLabel = isHoofdvestiging ? 'Hoofdvestiging' : 'Vestiging';
                
                html += `
                    <div class="kvk-company">
                        <div class="kvk-company-name">
                            <i class="${typeIcon}" style="color: ${typeColor}; margin-right: 6px;"></i>
                            ${company.naam}
                            <span style="font-size: 10px; background: ${typeColor}; color: white; padding: 2px 6px; border-radius: 10px; margin-left: 8px;">${typeLabel}</span>
                        </div>
                        <div class="kvk-company-details">
                            <div><strong>KVK:</strong> ${company.kvknummer || 'Onbekend'}</div>
                            ${company.vestigingsnummer ? `<div><strong>Vestiging:</strong> ${company.vestigingsnummer}</div>` : ''}
                            <div><strong>Activiteit:</strong> ${company.hoofdactiviteit || 'Onbekend'}</div>
                            <div><strong>Status:</strong> <span style="color: ${company.status === 'Actief' ? '#28a745' : '#dc3545'};">${company.status || 'Onbekend'}</span></div>
                            ${company.rechtsvorm ? `<div><strong>Rechtsvorm:</strong> ${company.rechtsvorm}</div>` : ''}
                            ${company.website ? `<div><strong>Website:</strong> <a href="${company.website.startsWith('http') ? company.website : 'https://' + company.website}" target="_blank" style="color: #76bc94;">${company.website}</a></div>` : ''}
                            ${company.handelsnamen && company.handelsnamen.length > 0 ? `<div><strong>Handelsnamen:</strong> ${company.handelsnamen.join(', ')}</div>` : ''}
                            ${company.sbiActiviteiten && company.sbiActiviteiten.length > 0 ? `<div><strong>SBI codes:</strong> ${company.sbiActiviteiten.map(sbi => sbi.sbiCode).join(', ')}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `<div style="margin-top: 12px; padding: 8px; background: #f8f9fa; border-radius: 6px; font-size: 11px; color: #666; text-align: center;">
                <i class="fas fa-info-circle"></i> 
                Gegevens via OpenKVK API (overheid.io)
                <br><small>Laatste update: ${new Date().toLocaleDateString('nl-NL')}</small>
            </div>`;
            
            kvkContent.innerHTML = html;
        }

        // ========================================
        // BAG INFORMATION FUNCTIONS
        // ========================================

        function getBagInfo(latlng) {
            console.log('BAG info requested for:', latlng);
            
            const point = map.latLngToContainerPoint(latlng);
            const size = map.getSize();
            const bounds = map.getBounds();
            
            console.log('Map pixel point:', point);
            console.log('Map size:', size);
            console.log('Map bounds WGS84:', bounds);
            
            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            
            console.log('WGS84 BBOX:', bbox);
            
            const wmsUrl = `https://service.pdok.nl/lv/bag/wms/v2_0?` +
                `QUERY_LAYERS=pand&` +
                `INFO_FORMAT=application%2Fjson&` +
                `REQUEST=GetFeatureInfo&` +
                `SERVICE=WMS&` +
                `VERSION=1.3.0&` +
                `FORMAT=image%2Fpng&` +
                `STYLES=&` +
                `TRANSPARENT=true&` +
                `LAYERS=pand&` +
                `FEATURE_COUNT=5&` +
                `I=${Math.round(point.x)}&` +
                `J=${Math.round(point.y)}&` +
                `WIDTH=${size.x}&` +
                `HEIGHT=${size.y}&` +
                `CRS=EPSG%3A4326&` +
                `BBOX=${bbox}`;
            
            console.log('BAG WMS URL:', wmsUrl);
            
            fetch(wmsUrl)
                .then(response => {
                    console.log('BAG Response status:', response.status);
                    console.log('BAG Response content-type:', response.headers.get('content-type'));
                    return response.text();
                })
                .then(text => {
                    console.log('BAG Raw response (first 200 chars):', text.substring(0, 200));
                    
                    if (text.trim().startsWith('<')) {
                        console.error('Server returned HTML (error page):', text);
                        throw new Error('Server returned HTML error page instead of JSON');
                    }
                    
                    try {
                        const data = JSON.parse(text);
                        console.log('BAG Parsed data:', data);
                        
                        if (data.features && data.features.length > 0) {
                            console.log('Found', data.features.length, 'pand(en)');
                            console.log('First pand properties:', data.features[0].properties);
                            showBagInfo(data.features[0]);
                        } else {
                            console.log('No pand found at clicked location');
                            showBagInfo(null, 'Geen pand gevonden op deze locatie - probeer preciezer te klikken');
                        }
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError);
                        console.error('Response text:', text);
                        showBagInfo(null, `JSON parse fout: ${parseError.message}`);
                    }
                })
                .catch(error => {
                    console.error('BAG WMS fout:', error);
                    showBagInfo(null, `Fout bij ophalen BAG gegevens: ${error.message}`);
                });
        }

        function showBagInfo(featureData, errorMessage = null) {
            const panel = document.getElementById('infoPanel');
            const content = document.getElementById('infoContent');
            
            if (errorMessage) {
                content.innerHTML = `<p style="color: #e74c3c; padding: 10px;">${errorMessage}</p>`;
            } else if (!featureData) {
                content.innerHTML = '<p style="padding: 10px;">Geen pand gevonden op deze locatie.</p>';
            } else {
                const props = featureData.properties || {};
                console.log('BAG Properties:', props);
                
                let infoHTML = '';
                
                const fieldMapping = {
                    'aantal_verblijfsobjecten': 'Aantal verblijfsobjecten',
                    'bouwjaar': 'Bouwjaar',
                    'oorspronkelijkbouwjaar': 'Oorspronkelijk bouwjaar',
                    'gebruiksdoel': 'Gebruiksdoel',
                    'identificatie': 'Identificatie',
                    'pandidentificatie': 'Pand ID',
                    'oppervlakte_max': 'Oppervlakte max (m²)',
                    'oppervlakte_min': 'Oppervlakte min (m²)',
                    'oppervlakte': 'Oppervlakte (m²)',
                    'rdf_seealso': 'BAG Link',
                    'status': 'Status',
                    'pandstatus': 'Pand status',
                    'voorkomenidentificatie': 'Voorkomen ID',
                    'documentdatum': 'Document datum',
                    'functie': 'Functie'
                };
                
                for (const [key, label] of Object.entries(fieldMapping)) {
                    if (props[key] !== undefined && props[key] !== null && props[key] !== '') {
                        let value = props[key];
                        
                        if (key === 'rdf_seealso' && typeof value === 'string') {
                            const shortUrl = value.length > 50 ? value.substring(0, 47) + '...' : value;
                            value = `<a href="${value}" target="_blank" style="color: #76bc94; text-decoration: none;">${shortUrl}</a>`;
                        } else if (key === 'documentdatum' && value) {
                            value = new Date(value).toLocaleDateString('nl-NL');
                        } else if (typeof value === 'object') {
                            value = JSON.stringify(value);
                        }
                        
                        infoHTML += `
                            <div class="info-item">
                                <div class="info-label">${label}</div>
                                <div class="info-value">${value}</div>
                            </div>
                        `;
                    }
                }
                
                for (const [key, value] of Object.entries(props)) {
                    if (!fieldMapping[key] && value !== undefined && value !== null && value !== '') {
                        let displayValue = value;
                        if (typeof value === 'object') {
                            displayValue = JSON.stringify(value);
                        }
                        
                        infoHTML += `
                            <div class="info-item">
                                <div class="info-label">${key}</div>
                                <div class="info-value">${displayValue}</div>
                            </div>
                        `;
                    }
                }
                
                if (infoHTML === '') {
                    infoHTML = `
                        <div class="info-item">
                            <div class="info-label">Ruwe data</div>
                            <div class="info-value"><pre style="white-space: pre-wrap; font-size: 11px;">${JSON.stringify(featureData, null, 2)}</pre></div>
                        </div>
                    `;
                }
                
                content.innerHTML = infoHTML;
            }
            
            panel.style.display = 'block';
        }

        async function getBagAndKvkInfo(latlng) {
            console.log('=== getBagAndKvkInfo called ===');
            console.log('Getting BAG and KVK info for:', latlng);
            
            getBagInfo(latlng);
            
            const kvkSection = document.getElementById('kvkSection');
            const kvkContent = document.getElementById('kvkContent');
            
            console.log('KVK section element:', kvkSection);
            console.log('KVK content element:', kvkContent);
            
            if (!kvkSection || !kvkContent) {
                console.error('KVK elements not found!');
                return;
            }
            
            kvkSection.style.display = 'block';
            kvkContent.innerHTML = '<div class="kvk-loading"><i class="fas fa-spinner fa-spin"></i> KVK gegevens ophalen...</div>';
            
            try {
                console.log('Starting reverse geocoding...');
                const address = await reverseGeocode(latlng);
                console.log('Reverse geocoded address:', address);
                
                if (address && address.postcode && address.huisnummer) {
                    console.log('Address found, looking up KVK with:', address.postcode, address.huisnummer);
                    const companies = await getKvkCompanies(address.postcode, address.huisnummer);
                    console.log('KVK companies found:', companies);
                    displayKvkResults(companies, address);
                } else {
                    console.log('No valid address found for KVK lookup');
                    kvkContent.innerHTML = '<div class="kvk-error">Geen adresgegevens gevonden voor KVK lookup</div>';
                }
            } catch (error) {
                console.error('KVK lookup error:', error);
                kvkContent.innerHTML = '<div class="kvk-error">Fout bij ophalen KVK gegevens: ' + error.message + '</div>';
            }
        }

        function reverseGeocode(latlng) {
            const url = `https://api.pdok.nl/bzk/locatieserver/search/v3_1/reverse?lat=${latlng.lat}&lon=${latlng.lng}&type=adres&rows=1`;
            
            console.log('Reverse geocoding URL:', url);
            
            return fetch(url)
                .then(response => {
                    console.log('Reverse geocoding response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Reverse geocoding data:', data);
                    if (data.response && data.response.docs && data.response.docs.length > 0) {
                        const doc = data.response.docs[0];
                        console.log('Found address doc:', doc);
                        
                        let postcode = doc.postcode;
                        let huisnummer = doc.huisnummer;
                        
                        if (!postcode && doc.weergavenaam) {
                            const postcodeMatch = doc.weergavenaam.match(/(\d{4}\s*[A-Z]{2})/);
                            if (postcodeMatch) {
                                postcode = postcodeMatch[1].replace(/\s/g, '');
                            }
                        }
                        
                        if (!huisnummer && doc.weergavenaam) {
                            const huisnummerMatch = doc.weergavenaam.match(/(\d+)/);
                            if (huisnummerMatch) {
                                huisnummer = huisnummerMatch[1];
                            }
                        }
                        
                        const addressInfo = {
                            postcode: postcode,
                            huisnummer: huisnummer,
                            straatnaam: doc.straatnaam,
                            woonplaatsnaam: doc.woonplaatsnaam,
                            volledigAdres: doc.weergavenaam
                        };
                        console.log('Parsed address info:', addressInfo);
                        return addressInfo;
                    }
                    console.log('No address found in reverse geocoding');
                    return null;
                })
                .catch(error => {
                    console.error('Reverse geocoding error:', error);
                    return null;
                });
        }

        // ========================================
        // MEASUREMENT FUNCTIONALITY
        // ========================================

        let measureMode = null;
        let measurePoints = [];
        let measureLine = null;
        let measurePolygon = null;
        let measureMarkers = [];

        function startMeasuring(mode) {
            clearMeasurements();
            measureMode = mode;
            
            document.querySelectorAll('.measure-panel .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (mode === 'distance') {
                document.getElementById('measureDistance').classList.add('active');
                showStatus('Klik op de kaart om afstand te meten', 'info');
            } else if (mode === 'area') {
                document.getElementById('measureArea').classList.add('active');
                showStatus('Klik op de kaart om oppervlakte te meten', 'info');
            }
            
            map.getContainer().style.cursor = 'crosshair';
        }

        function clearMeasurements() {
            measureMode = null;
            measurePoints = [];
            
            if (measureLine) {
                map.removeLayer(measureLine);
                measureLine = null;
            }
            
            if (measurePolygon) {
                map.removeLayer(measurePolygon);
                measurePolygon = null;
            }
            
            measureMarkers.forEach(marker => map.removeLayer(marker));
            measureMarkers = [];
            
            document.getElementById('measureResults').innerHTML = '';
            document.querySelectorAll('.measure-panel .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            map.getContainer().style.cursor = '';
            showStatus('Metingen gewist', 'info');
        }

        function calculateDistance(points) {
            let totalDistance = 0;
            for (let i = 0; i < points.length - 1; i++) {
                totalDistance += points[i].distanceTo(points[i + 1]);
            }
            return totalDistance;
        }

        function calculateArea(points) {
            if (points.length < 3) return 0;
            
            let area = 0;
            const n = points.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                area += points[i].lat * points[j].lng;
                area -= points[j].lat * points[i].lng;
            }
            
            area = Math.abs(area) / 2;
            return area * 111319.9 * 111319.9 * Math.cos(points[0].lat * Math.PI / 180);
        }

        function updateMeasureResult() {
            const resultsDiv = document.getElementById('measureResults');
            
            if (measureMode === 'distance' && measurePoints.length > 1) {
                const distance = calculateDistance(measurePoints);
                const distanceText = distance > 1000 ? 
                    `${(distance / 1000).toFixed(2)} km` : 
                    `${distance.toFixed(0)} m`;
                
                resultsDiv.innerHTML = `<div class="measure-result">
                    <i class="fas fa-ruler-horizontal"></i> Afstand: ${distanceText}
                </div>`;
            } else if (measureMode === 'area' && measurePoints.length > 2) {
                const area = calculateArea(measurePoints);
                const areaText = area > 10000 ? 
                    `${(area / 10000).toFixed(2)} ha` : 
                    `${area.toFixed(0)} m²`;
                
                resultsDiv.innerHTML = `<div class="measure-result">
                    <i class="fas fa-draw-polygon"></i> Oppervlakte: ${areaText}
                </div>`;
            }
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================

        // Layer control event listeners
        document.getElementById('osmLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.osm);
            } else {
                map.removeLayer(layers.osm);
            }
        });

        document.getElementById('topoLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.topo);
            } else {
                map.removeLayer(layers.topo);
            }
        });

        document.getElementById('bagLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.bag);
                showStatus('BAG panden laag geactiveerd - klik op panden voor info', 'info');
            } else {
                map.removeLayer(layers.bag);
            }
        });

        document.getElementById('luchtfotoLayer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(layers.luchtfoto);
            } else {
                map.removeLayer(layers.luchtfoto);
            }
        });

        // Search tab functionality
        document.getElementById('searchTabAddress').addEventListener('click', function() {
            document.getElementById('searchTabAddress').classList.add('active');
            document.getElementById('searchTabKvk').classList.remove('active');
            document.getElementById('addressSearch').style.display = 'block';
            document.getElementById('kvkSearch').style.display = 'none';
            document.getElementById('searchResults').innerHTML = '';
        });

        document.getElementById('searchTabKvk').addEventListener('click', function() {
            document.getElementById('searchTabKvk').classList.add('active');
            document.getElementById('searchTabAddress').classList.remove('active');
            document.getElementById('kvkSearch').style.display = 'block';
            document.getElementById('addressSearch').style.display = 'none';
            document.getElementById('searchResults').innerHTML = '';
        });

        // KVK search functionality
        document.getElementById('kvkSearchBtn').addEventListener('click', async function() {
            console.log('=== KVK SEARCH BUTTON CLICKED ===');
            const query = document.getElementById('kvkSearchInput').value.trim();
            
            if (!query) {
                showStatus('Voer een KVK nummer of bedrijfsnaam in', 'error');
                return;
            }
            
            console.log('Searching for:', query);
            
            const container = document.getElementById('searchResults');
            container.innerHTML = '<div class="search-result"><i class="fas fa-spinner fa-spin"></i> OpenKVK gegevens ophalen...</div>';
            
            try {
                const companies = await searchKvkNumber(query);
                console.log('Search results:', companies);
                
                if (companies.length > 0) {
                    showStatus(`${companies.length} bedrijven gevonden`, 'success');
                } else {
                    showStatus('Geen bedrijven gevonden', 'info');
                }
                
                displayKvkSearchResults(companies);
                
            } catch (error) {
                console.error('❌ KVK search error:', error);
                container.innerHTML = `<div class="search-result" style="color: #e74c3c;">❌ Fout: ${error.message}</div>`;
                showStatus('Fout bij zoeken', 'error');
            }
        });

        document.getElementById('kvkSearchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('kvkSearchBtn').click();
            }
        });

        // Address search functionality
        document.getElementById('searchBtn').addEventListener('click', () => {
            console.log('Address search button clicked');
            searchAddress();
        });

        document.getElementById('searchInput').addEventListener('input', function(e) {
            console.log('Search input changed:', e.target.value);
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            if (query.length >= 2) {
                searchTimeout = setTimeout(() => {
                    console.log('Auto-search triggered for:', query);
                    searchAddress();
                }, 300);
            } else {
                console.log('Query too short, clearing results');
                document.getElementById('searchResults').innerHTML = '';
            }
        });
        
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                console.log('Enter key pressed in address search');
                clearTimeout(searchTimeout);
                searchAddress();
            }
        });

        // Measurement controls
        document.getElementById('measureDistance').addEventListener('click', () => {
            startMeasuring('distance');
        });

        document.getElementById('measureArea').addEventListener('click', () => {
            startMeasuring('area');
        });

        document.getElementById('clearMeasurements').addEventListener('click', clearMeasurements);

        // Info panel controls
        document.getElementById('closeInfo').addEventListener('click', function() {
            document.getElementById('infoPanel').style.display = 'none';
            document.getElementById('kvkSection').style.display = 'none';
        });

        // Map click event handler
        map.on('click', function(e) {
            console.log('=== MAP CLICK EVENT ===');
            console.log('Click coordinates:', e.latlng);
            console.log('Measure mode:', measureMode);
            console.log('BAG layer checked:', document.getElementById('bagLayer').checked);
            
            // Check if BAG layer is active and no measurement in progress
            if (!measureMode && document.getElementById('bagLayer').checked) {
                console.log('Calling getBagAndKvkInfo...');
                getBagAndKvkInfo(e.latlng);
            } else {
                console.log('Not calling getBagAndKvkInfo because:');
                console.log('- measureMode:', measureMode);
                console.log('- bagLayer checked:', document.getElementById('bagLayer').checked);
            }
            
            if (!measureMode) return;
            
            measurePoints.push(e.latlng);
            
            // Add marker
            const marker = L.circleMarker(e.latlng, {
                color: '#76bc94',
                radius: 6
            }).addTo(map);
            measureMarkers.push(marker);
            
            if (measureMode === 'distance') {
                if (measurePoints.length > 1) {
                    if (measureLine) {
                        map.removeLayer(measureLine);
                    }
                    measureLine = L.polyline(measurePoints, {
                        color: '#76bc94',
                        weight: 3
                    }).addTo(map);
                }
                updateMeasureResult();
            } else if (measureMode === 'area') {
                if (measurePoints.length > 2) {
                    if (measurePolygon) {
                        map.removeLayer(measurePolygon);
                    }
                    measurePolygon = L.polygon(measurePoints, {
                        color: '#76bc94',
                        fillColor: '#76bc94',
                        fillOpacity: 0.3
                    }).addTo(map);
                    updateMeasureResult();
                }
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && measureMode) {
                clearMeasurements();
            }
        });

        // ========================================
        // INITIALIZATION
        // ========================================

        // Test OpenKVK connection on load
        window.addEventListener('load', function() {
            console.log('✅ WebGIS loaded successfully');
            showStatus('WebGIS geladen - OpenKVK integratie actief', 'success');
            
            // Test OpenKVK connection
            setTimeout(() => {
                testKvkApi();
            }, 1000);
        });

        // Make functions globally available for console testing
        window.testKvkApi = testKvkApi;
        window.searchKvkNumber = searchKvkNumber;
        window.getKvkCompanies = getKvkCompanies;

        console.log('✅ OpenKVK WebGIS integration loaded');
        console.log('ℹ️ Available test functions:');
        console.log('  - testKvkApi() - Test OpenKVK API connection');
        console.log('  - searchKvkNumber("12345678") - Search by KVK number');
        console.log('  - getKvkCompanies("1234AB", "1") - Search by address');
    </script>
</body>
</html>
